---
name: "Deploy Environment Services"
on:
  workflow_dispatch:
    inputs:
      bfd-env:
        description: The BFD environment to deploy services to
        required: true
      services:
        description: Comma-separated list of services to deploy
        default: >-
          config,
          cluster,
          database,
          eft,
          locust,
          migrator,
          ccw-pipeline,
          npi-pipeline,
          rda-pipeline,
          server,
          ccw-pipeline-metrics,
          rda-pipeline-metrics,
          server-metrics,
          ccw-pipeline-alarms,
          rda-pipeline-alarms,
          server-alarms
        required: true
      aws-region:
        description: >-
          Override the AWS Region
        default: us-east-1
        type: choice
        options:
          - us-east-1
          - us-west-2
        required: true
      skip-applies:
        description: >-
          If true, skips the apply step for each Terraservice such that only the plans are generated
        default: false
        required: false
        type: boolean

permissions:
  id-token: write # This is required for requesting the AWS IAM OIDC JWT
  contents: write # This is required for actions/checkout

env:
  DEPLOY_JOBS_MATRIX_JSON: |
    {
      "01": [
        { "layer": "01", "service": "config", "runner": "lambda" }
      ],
      "02": [
        { "layer": "02", "service": "cluster", "runner": "lambda" },
        { "layer": "02", "service": "database", "runner": "small" }
      ],
      "03": [
        { "layer": "03", "service": "locust", "runner": "lambda" },
        { "layer": "03", "service": "migrator", "runner": "small" }
      ],
      "04": [
        { "layer": "04", "service": "ccw-pipeline", "runner": "lambda" },
        { "layer": "04", "service": "npi-pipeline", "runner": "lambda" },
        { "layer": "04", "service": "rda-pipeline", "runner": "lambda" },
        { "layer": "04", "service": "server", "runner": "lambda" }
      ],
      "05": [
        { "layer": "05", "service": "ccw-pipeline-metrics", "runner": "lambda" },
        { "layer": "05", "service": "rda-pipeline-metrics", "runner": "lambda" },
        { "layer": "05", "service": "server-metrics", "runner": "lambda" }
      ],
      "06": [
        { "layer": "06", "service": "ccw-pipeline-alarms", "runner": "lambda" },
        { "layer": "06", "service": "rda-pipeline-alarms", "runner": "lambda" },
        { "layer": "06", "service": "server-alarms", "runner": "lambda" }
      ]
    }
  DEFAULT_LOG_GROUP: /bfd/${{ inputs.bfd-env }}/github_actions/deploy_env_services/tofu
  PARENT_ENV_ACCOUNT_MAP: |
    {
      "test": "non-prod",
      "sandbox": "prod",
      "prod": "prod"
    }
  ACCOUNT_ROLE_MAP: |
    {
      "prod": "${{ secrets.PROD_ACCOUNT_GHA_ROLE_ARN }}",
      "non-prod": "${{ secrets.NON_PROD_ACCOUNT_GHA_ROLE_ARN }}"
    }

defaults:
  run:
    shell: bash

jobs:
  setup:
    runs-on: ubuntu-24.04
    outputs:
      account-type: ${{ steps.get-account-type.outputs.account-type }}
      role-arn: ${{ steps.get-role-arn.outputs.role-arn }}
      deploy-jobs-matrix-json: ${{ steps.get-deploy-jobs-matrix-json.outputs.deploy-jobs-matrix-json }}
    steps:
      - name: Get account type from parent env
        id: get-account-type
        run: |
          parent_env="$(echo "${{ inputs.bfd-env }}" | grep -Po '(prod|sandbox|test)$')"
          account_type="$(jq -r --arg parent_env "$parent_env" '.[$parent_env]' <<<"$PARENT_ENV_ACCOUNT_MAP")"

          echo "account-type=$account_type" >> "$GITHUB_OUTPUT"

      - name: Get role ARN
        id: get-role-arn
        run: |
          role_arn="$(jq -r --arg account_type "${{ steps.get-account-type.outputs.account-type }}" '.[$account_type]' <<<"$ACCOUNT_ROLE_MAP")"

          echo "::add-mask::$role_arn"
          echo "role-arn=$role_arn" >> "$GITHUB_OUTPUT"

      - name: Get filtered deploy jobs matrix JSON as output
        id: get-deploy-jobs-matrix-json
        env:
          SERVICES: ${{ inputs.services }}
        run: |
          deploy_jobs_matrix_json="$(
            jq -c --arg services "$SERVICES" '
              # Convert the CSV list of services into an array
              ($services | split(",") | map(gsub("^\s+|\s+$"; ""))) as $filterServices
              | to_entries
              | map(
                  .value |= map(select(.service | IN($filterServices[])))
                )
              | from_entries
            ' <<<"$DEPLOY_JOBS_MATRIX_JSON"
          )"

          echo "deploy-jobs-matrix-json=$deploy_jobs_matrix_json" >> "$GITHUB_OUTPUT"

  deploy-layer-01:
    needs: setup
    strategy:
      matrix:
        context: ${{ fromJson(needs.setup.outputs.deploy-jobs-matrix-json)['01'] }}
    runs-on: codebuild-bfd-${{ needs.setup.outputs.account-type }}-platform-${{ matrix.context.runner }}-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup.outputs.role-arn }}
          role-session-name: deploy-${{ matrix.context.layer }}-${{ matrix.context.service }}-${{ github.run_id }}-${{ github.run_attempt }}
          aws-region: ${{ inputs.aws-region }}

      - name: Deploy ${{ matrix.context.service }}
        uses: ./.github/actions/bfd-deploy-env-service
        with:
          bfd-env: ${{ inputs.bfd-env }}
          service-path: ops/services/${{ matrix.context.layer }}-${{ matrix.context.service }}
          cw-log-group: ${{ env.DEFAULT_LOG_GROUP }}
          cw-log-stream: config-${{ github.run_id }}-${{ github.run_attempt }}
          skip-apply: ${{ inputs.skip-applies && 'true' || 'false' }}

  deploy-layer-02:
    needs: [setup, deploy-layer-01]
    strategy:
      matrix:
        context: ${{ fromJson(needs.setup.outputs.deploy-jobs-matrix-json)['02'] }}
    runs-on: codebuild-bfd-${{ needs.setup.outputs.account-type }}-platform-${{ matrix.context.runner }}-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup.outputs.role-arn }}
          role-session-name: deploy-${{ matrix.context.layer }}-${{ matrix.context.service }}-${{ github.run_id }}-${{ github.run_attempt }}
          aws-region: ${{ inputs.aws-region }}

      - name: Deploy ${{ matrix.context.service }}
        uses: ./.github/actions/bfd-deploy-env-service
        with:
          bfd-env: ${{ inputs.bfd-env }}
          service-path: ops/services/${{ matrix.context.layer }}-${{ matrix.context.service }}
          cw-log-group: ${{ env.DEFAULT_LOG_GROUP }}
          cw-log-stream: config-${{ github.run_id }}-${{ github.run_attempt }}
          skip-apply: ${{ inputs.skip-applies && 'true' || 'false' }}

  deploy-layer-03:
    needs: [setup, deploy-layer-02]
    strategy:
      matrix:
        context: ${{ fromJson(needs.setup.outputs.deploy-jobs-matrix-json)['03'] }}
    runs-on: codebuild-bfd-${{ needs.setup.outputs.account-type }}-platform-${{ matrix.context.runner }}-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup.outputs.role-arn }}
          role-session-name: deploy-${{ matrix.context.layer }}-${{ matrix.context.service }}-${{ github.run_id }}-${{ github.run_attempt }}
          aws-region: ${{ inputs.aws-region }}

      - name: Deploy ${{ matrix.context.service }}
        uses: ./.github/actions/bfd-deploy-env-service
        with:
          bfd-env: ${{ inputs.bfd-env }}
          service-path: ops/services/${{ matrix.context.layer }}-${{ matrix.context.service }}
          cw-log-group: ${{ env.DEFAULT_LOG_GROUP }}
          cw-log-stream: config-${{ github.run_id }}-${{ github.run_attempt }}
          skip-apply: ${{ inputs.skip-applies && 'true' || 'false' }}

  deploy-layer-04:
    needs: [setup, deploy-layer-03]
    strategy:
      matrix:
        context: ${{ fromJson(needs.setup.outputs.deploy-jobs-matrix-json)['04'] }}
    runs-on: codebuild-bfd-${{ needs.setup.outputs.account-type }}-platform-${{ matrix.context.runner }}-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup.outputs.role-arn }}
          role-session-name: deploy-${{ matrix.context.layer }}-${{ matrix.context.service }}-${{ github.run_id }}-${{ github.run_attempt }}
          aws-region: ${{ inputs.aws-region }}

      - name: Deploy ${{ matrix.context.service }}
        uses: ./.github/actions/bfd-deploy-env-service
        with:
          bfd-env: ${{ inputs.bfd-env }}
          service-path: ops/services/${{ matrix.context.layer }}-${{ matrix.context.service }}
          cw-log-group: ${{ env.DEFAULT_LOG_GROUP }}
          cw-log-stream: config-${{ github.run_id }}-${{ github.run_attempt }}
          skip-apply: ${{ inputs.skip-applies && 'true' || 'false' }}

  deploy-layer-05:
    needs: [setup, deploy-layer-04]
    strategy:
      matrix:
        context: ${{ fromJson(needs.setup.outputs.deploy-jobs-matrix-json)['05'] }}
    runs-on: codebuild-bfd-${{ needs.setup.outputs.account-type }}-platform-${{ matrix.context.runner }}-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup.outputs.role-arn }}
          role-session-name: deploy-${{ matrix.context.layer }}-${{ matrix.context.service }}-${{ github.run_id }}-${{ github.run_attempt }}
          aws-region: ${{ inputs.aws-region }}

      - name: Deploy ${{ matrix.context.service }}
        uses: ./.github/actions/bfd-deploy-env-service
        with:
          bfd-env: ${{ inputs.bfd-env }}
          service-path: ops/services/${{ matrix.context.layer }}-${{ matrix.context.service }}
          cw-log-group: ${{ env.DEFAULT_LOG_GROUP }}
          cw-log-stream: config-${{ github.run_id }}-${{ github.run_attempt }}
          skip-apply: ${{ inputs.skip-applies && 'true' || 'false' }}

  deploy-layer-06:
    needs: [setup, deploy-layer-05]
    strategy:
      matrix:
        context: ${{ fromJson(needs.setup.outputs.deploy-jobs-matrix-json)['06'] }}
    runs-on: codebuild-bfd-${{ needs.setup.outputs.account-type }}-platform-${{ matrix.context.runner }}-${{ github.run_id }}-${{ github.run_attempt }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref_name }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ needs.setup.outputs.role-arn }}
          role-session-name: deploy-${{ matrix.context.layer }}-${{ matrix.context.service }}-${{ github.run_id }}-${{ github.run_attempt }}
          aws-region: ${{ inputs.aws-region }}

      - name: Deploy ${{ matrix.context.service }}
        uses: ./.github/actions/bfd-deploy-env-service
        with:
          bfd-env: ${{ inputs.bfd-env }}
          service-path: ops/services/${{ matrix.context.layer }}-${{ matrix.context.service }}
          cw-log-group: ${{ env.DEFAULT_LOG_GROUP }}
          cw-log-stream: config-${{ github.run_id }}-${{ github.run_attempt }}
          skip-apply: ${{ inputs.skip-applies && 'true' || 'false' }}

