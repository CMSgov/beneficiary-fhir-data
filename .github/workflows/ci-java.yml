name: 'CI - Java'
on:
  schedule:
    - cron: '13 8 * * 1-5'  # Early morning continental US hours, Monday through Friday
  pull_request:
  merge_group:
  push:
    branches:
      - master

permissions:
  id-token: write
  contents: write

env:
  # workflow file matchers - workflow jobs will only run if matching files are found
  # please see https://github.com/CMSgov/beneficiary-fhir-data/pull/773 for why we
  # are using this workflow logic
  # NOTE: The expression below can be extended to multi-line
  # using a '\' as a continuation character.
  # https://stackoverflow.com/questions/6268391/is-there-a-way-to-represent-a-long-string-that-doesnt-have-any-whitespace-on-mul
  workflow_files_re: "^apps/(?!bfd-model/bfd-model-idr|utils).+$|^.github/workflows/ci-java.yml$"
  AWS_REGION: us-east-1
  SONAR_PROJECT_KEY: bfd-parent
  SONAR_HOST_URL: https://sonarqube.cloud.cms.gov

jobs:
  workflow:
    name: Checking workflow
    runs-on: ubuntu-24.04
    outputs:
      files: ${{ steps.workflow_files.outputs.files }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: workflow_files
        name: Set output
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$(git diff --name-only --diff-filter=ACMRTD HEAD^ HEAD | grep -P '${{ env.workflow_files_re }}')" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  mvn-fmt-maven-plugin:
    runs-on: ubuntu-24.04
    needs: workflow
    if: needs.workflow.outputs.files
    steps:
      - uses: actions/checkout@v4
      - name: 'Setup JDK'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
      - name: 'Run maven ${{ matrix.mvn_commmand }}'
        run: mvn com.spotify.fmt:fmt-maven-plugin:check
        working-directory: ./apps

  mvn-verify:
    runs-on: codebuild-bfd-non-prod-platform-large-${{ github.run_id }}-${{ github.run_attempt }}
    needs: workflow
    if: needs.workflow.outputs.files
    steps:
      - name: 'Checkout repo'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 'Setup JDK'
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'
      - name: Cache local Maven build-cache
        uses: actions/cache@v4
        with:
          path: ~/.m2/build-cache
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
      - name: Install uv
        uses: astral-sh/setup-uv@v5
      - name: Configure AWS credentials
        id: config-aws-creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.NON_PROD_ACCOUNT_GHA_ROLE_ARN }}
          role-session-name: ci-java
          aws-region: us-east-1

      - name: Mask sensitive AWS data
        id: mask-sensitive-aws-data
        run: |
          caller_id="$(aws sts get-caller-identity)"
          account_num="$(jq -r '.Account' <<<${caller_id})"
          role_arn="$(jq -r '.Arn' <<<${caller_id})"
          user_id="$(jq -r '.UserId' <<<${caller_id})"

          echo "::add-mask::$account_num"
          echo "::add-mask::$role_arn"
          echo "::add-mask::$user_id"

      - name: Set env vars from AWS params
        uses: cmsgov/cdap/actions/aws-params-env-action@main
        with:
          params: |
            SONAR_TOKEN=/bfd/platform/sonar/sensitive/service_account_access_key

      - name: 'Run Maven Build'
        run: |
          mvn --threads 1C \
          --no-transfer-progress \
          -Dmaven.build.cache.enabled=true \
          -Dapidocgen.skip=false \
          -Dmaven.jacoco.skip=false \
          -Dmaven.source.skip=true \
          clean install
        working-directory: ./apps

      - name: 'Generate, Upload Build Reports'
        run: |
          mvn sonar:sonar \
          --no-transfer-progress \
          -Dsonar.ci.autoconfig.disabled=true \
          -Dsonar.projectKey="$SONAR_PROJECT_KEY" \
          -Dsonar.host.url="$SONAR_HOST_URL" \
          -Dsonar.token="$SONAR_TOKEN" \
          -Dmaven.build.cache.enabled=true \
          -DskipITs \
          -DskipTests \
          -Dsonar.exclusions='*.java' \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/coverage-reports/jacoco-it/jacoco.xml,target/coverage-reports/jacoco-ut/jacoco.xml
        working-directory: ./apps

# TODO: Conformance testing is currently missing from mvn-verify. BFD-3245 will re-examine conformance regression testing in BFD.
