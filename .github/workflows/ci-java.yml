name: 'CI - Java'
on: pull_request

env:
  # workflow file matchers - workflow jobs will only run if matching files are found
  # please see https://github.com/CMSgov/beneficiary-fhir-data/pull/773 for why we
  # are using this workflow logic
  bfd-pipeline-re: (^apps/bfd-pipeline|^apps/bfd-model|^apps/bfd-shared-utils|^ops/ansible/roles/bfd-pipeline)

jobs:
  verify:
    name: mvn-verify
    runs-on: ubuntu-latest
    outputs:
      pipeline: ${{ steps.workflow_files.outputs.pipeline }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
      - id: mvn-verify
        run: |
          git diff --name-only --diff-filter=ACMRTD HEAD^ HEAD
          echo "::set-output name=pipeline::$(git diff --name-only --diff-filter=ACMRTD HEAD^ HEAD | grep -E '${{ env.bfd-pipeline-re }}')"

  mvn-fmt-maven-plugin:
    runs-on: ubuntu-latest
    needs: verify
    steps:
      - uses: actions/checkout@v2
      - name: 'Setup JDK'
        uses: actions/setup-java@v1
        with:
          java-version: '11'
      - name: 'Generate maven toolchain config'
        run: |
          cat << EOF > ~/.m2/toolchains.xml
          <toolchains>
            <toolchain>
              <type>jdk</type>
              <provides>
                <version>11</version>
                <vendor>OpenJDK</vendor>
              </provides>
              <configuration>
                <jdkHome>$JAVA_HOME</jdkHome>
              </configuration>
            </toolchain>
          </toolchains>
          EOF
      - name: 'Run maven ${{ matrix.mvn_commmand }}'
        run: mvn com.coveo:fmt-maven-plugin:check
        working-directory: ./apps

  bfd-pipeline:
    needs: verify
    if: needs.verify.outputs.pipeline
    uses: ./.github/workflows/java.yml
    with:
      project: bfd-pipeline
  ansible-role-bfd-pipeline:
    needs:
      - verify
      - bfd-pipeline
    if: needs.verify.outputs.pipeline
    uses: ./.github/workflows/ci-ansible.yml
    with:
      role: bfd-pipeline
