name: Automated Python Test Gate for Lambda Updates

on:
  push:
    branches:
      - master
      - BFD-3524
    paths:
      - **/*.py
      - **/*requirement*.txt
  pull_request:
    branches:
      - master
      - BFD-3524
    paths:
        - **/*.py
        - **/*requirement*.txt
  workflow_dispatch:

jobs:
  lambda-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        id: code-checkout
        uses: actions/checkout@v4
        with:
            fetch-depth: 2

      - name: Set up Python
        id: python-setup
        uses: actions/setup-python@v5.1.1
        with:
          python-version: '3.11' # Specify the required Python version

      - name: Install dependencies
        id: dependency-install
        run: |
          python -m venv venv
          source venv/bin/activate
          pip install --upgrade pip

      - name: Determine changed files for push event
        id: list-push-changes
        if: github.event_name == 'push'
        run: |
            echo "Fetching list of changed files for push event..."
            CHANGEDPUSHFILES=$(git diff --name-only ${{ github.sha }}^ ${{ github.sha }})
            echo "Changed files: $CHANGEDPUSHFILES"
            echo "CHANGEDPUSHFILES=${CHANGEDPUSHFILES}" >> $GITHUB_OUTPUT

      - name: Determine changed files for pull request event
        id: list-pr-changes
        if: github.event_name == 'pull_request'
        run: |
              echo "Fetching list of changed files for pull request event..."
              PR_NUMBER=${{ github.event.pull_request.number }}
              CHANGEDPRFILES=$(gh pr diff $PR_NUMBER --name-only)
              echo "Changed files: $CHANGEDPRFILES"
              echo "CHANGEDPRFILES=${CHANGEDPRFILES}" >> $GITHUB_OUTPUT

      - name: Run Python Tests for affected folders
        id: run-pytest-set
        run: |
            LAMBDA_PATTERN="lambda_src"
            CHANGED_FILES=""
            CHANGED_FILES=$(echo $CHANGED_FILES ${{ steps.list-push-changes.outputs.CHANGEDPUSHFILES }})
            CHANGED_FILES=$(echo $CHANGED_FILES ${{ steps.list-pr-changes.outputs.CHANGEDPRFILES }})
            echo "Changed files: $CHANGED_FILES"
            IFS=',' read -r -a array <<< "$CHANGED_FILES"
            for element in "${array[@]}"
            do
                DIR=$(dirname "$element")
                echo "Affected source folder: $DIR"
                if [[ "${DIR}" =~ "${LAMBDA_PATTERN}" ]]
                then
                    # Perform actions based on the affected folders
                    if [ -e $DIR/*requirement*.txt ]
                    then
                        pip install -r $DIR/*requirement*.txt 
                    fi
                    ##source venv/bin/activate
                    pip install pytest
                    pytest $DIR/tests 
                fi
            done
