<?xml version="1.0"?>
<!DOCTYPE Configure PUBLIC "-//Jetty//Configure//EN" "http://www.eclipse.org/jetty/configure_9_3.dtd">

<!-- =============================================================== -->
<!-- Documentation of this file format can be found at: -->
<!-- http://wiki.eclipse.org/Jetty/Reference/jetty.xml_syntax -->
<!-- -->
<!-- For a description of the configuration mechanism, see the -->
<!-- output of: -->
<!-- java -jar start.jar -? -->
<!-- =============================================================== -->

<!-- =============================================================== -->
<!-- Configure a Jetty Server instance with an ID "Server" -->
<!-- Other configuration files may also configure the "Server" -->
<!-- ID, in which case they are adding configuration to the same -->
<!-- instance. If other configuration have a different ID, they -->
<!-- will create and configure another instance of Jetty. -->
<!-- Consult the javadoc of o.e.j.server.Server for all -->
<!-- configuration that may be set here. -->
<!-- =============================================================== -->
<Configure id="Server" class="org.eclipse.jetty.server.Server">

	<!-- =========================================================== -->
	<!-- Configure the Server Thread Pool. -->
	<!-- The server holds a common thread pool which is used by -->
	<!-- default as the executor used by all connectors and servlet -->
	<!-- dispatches. -->
	<!-- -->
	<!-- Configuring a fixed thread pool is vital to controlling the -->
	<!-- maximal memory footprint of the server and is a key tuning -->
	<!-- parameter for tuning. In an application that rarely blocks -->
	<!-- then maximal threads may be close to the number of 5*CPUs. -->
	<!-- In an application that frequently blocks, then maximal -->
	<!-- threads should be set as high as possible given the memory -->
	<!-- available. -->
	<!-- -->
	<!-- Consult the javadoc of o.e.j.util.thread.QueuedThreadPool -->
	<!-- for all configuration that may be set here. -->
	<!-- =========================================================== -->
	<!-- uncomment to change type of threadpool <Arg name="threadpool"><New 
		id="threadpool" class="org.eclipse.jetty.util.thread.QueuedThreadPool"/></Arg> -->
	<Get name="ThreadPool">
		<Set name="minThreads" type="int">
			<Property name="jetty.threadPool.minThreads" deprecated="threads.min"
				default="10" />
		</Set>
		<Set name="maxThreads" type="int">
			<Property name="jetty.threadPool.maxThreads" deprecated="threads.max"
				default="200" />
		</Set>
		<Set name="idleTimeout" type="int">
			<Property name="jetty.threadPool.idleTimeout" deprecated="threads.timeout"
				default="60000" />
		</Set>
		<Set name="detailedDump">false</Set>
	</Get>

	<!-- =========================================================== -->
	<!-- Add shared Scheduler instance -->
	<!-- =========================================================== -->
	<Call name="addBean">
		<Arg>
			<New class="org.eclipse.jetty.util.thread.ScheduledExecutorScheduler" />
		</Arg>
	</Call>

	<!-- =========================================================== -->
	<!-- Http Configuration. -->
	<!-- This is a common configuration instance used by all -->
	<!-- connectors that can carry HTTP semantics (HTTP, HTTPS, etc.) -->
	<!-- It configures the non wire protocol aspects of the HTTP -->
	<!-- semantic. -->
	<!-- -->
	<!-- This configuration is only defined here and is used by -->
	<!-- reference from other XML files such as jetty-http.xml, -->
	<!-- jetty-https.xml and other configuration files which -->
	<!-- instantiate the connectors. -->
	<!-- -->
	<!-- Consult the javadoc of o.e.j.server.HttpConfiguration -->
	<!-- for all configuration that may be set here. -->
	<!-- =========================================================== -->
	<New id="httpConfig" class="org.eclipse.jetty.server.HttpConfiguration">
		<Set name="secureScheme">
			<Property name="jetty.httpConfig.secureScheme" default="https" />
		</Set>
		<Set name="securePort">
			<Property name="jetty.httpConfig.securePort" deprecated="jetty.secure.port"
				default="8443" />
		</Set>
		<Set name="outputBufferSize">
			<Property name="jetty.httpConfig.outputBufferSize"
				deprecated="jetty.output.buffer.size" default="32768" />
		</Set>
		<Set name="outputAggregationSize">
			<Property name="jetty.httpConfig.outputAggregationSize"
				deprecated="jetty.output.aggregation.size" default="8192" />
		</Set>
		<Set name="requestHeaderSize">
			<Property name="jetty.httpConfig.requestHeaderSize"
				deprecated="jetty.request.header.size" default="8192" />
		</Set>
		<Set name="responseHeaderSize">
			<Property name="jetty.httpConfig.responseHeaderSize"
				deprecated="jetty.response.header.size" default="8192" />
		</Set>
		<Set name="sendServerVersion">
			<Property name="jetty.httpConfig.sendServerVersion"
				deprecated="jetty.send.server.version" default="true" />
		</Set>
		<Set name="sendDateHeader">
			<Property name="jetty.httpConfig.sendDateHeader" deprecated="jetty.send.date.header"
				default="false" />
		</Set>
		<Set name="headerCacheSize">
			<Property name="jetty.httpConfig.headerCacheSize" default="512" />
		</Set>
		<Set name="delayDispatchUntilContent">
			<Property name="jetty.httpConfig.delayDispatchUntilContent"
				deprecated="jetty.delayDispatchUntilContent" default="true" />
		</Set>
		<Set name="maxErrorDispatches">
			<Property name="jetty.httpConfig.maxErrorDispatches"
				default="10" />
		</Set>
		<Set name="blockingTimeout">
			<Property name="jetty.httpConfig.blockingTimeout" default="-1" />
		</Set>
		<Set name="persistentConnectionsEnabled">
			<Property name="jetty.httpConfig.persistentConnectionsEnabled"
				default="true" />
		</Set>
	</New>

	<!-- =========================================================== -->
	<!-- Set the default handler structure for the Server -->
	<!-- A handler collection is used to pass received requests to -->
	<!-- both the ContextHandlerCollection, which selects the next -->
	<!-- handler by context path and virtual host, and the -->
	<!-- DefaultHandler, which handles any requests not handled by -->
	<!-- the context handlers. -->
	<!-- Other handlers may be added to the "Handlers" collection, -->
	<!-- for example the jetty-requestlog.xml file adds the -->
	<!-- RequestLogHandler after the default handler -->
	<!-- =========================================================== -->
	<Set name="handler">
		<New id="Handlers" class="org.eclipse.jetty.server.handler.HandlerCollection">
			<Set name="handlers">
				<Array type="org.eclipse.jetty.server.Handler">
					<Item>
						<New id="Contexts"
							class="org.eclipse.jetty.server.handler.ContextHandlerCollection" />
					</Item>
					<Item>
						<New id="DefaultHandler" class="org.eclipse.jetty.server.handler.DefaultHandler" />
					</Item>
				</Array>
			</Set>
		</New>
	</Set>

	<!-- =========================================================== -->
	<!-- extra server options -->
	<!-- =========================================================== -->
	<Set name="stopAtShutdown">
		<Property name="jetty.server.stopAtShutdown" default="true" />
	</Set>
	<Set name="stopTimeout">5000</Set>
	<Set name="dumpAfterStart">
		<Property name="jetty.server.dumpAfterStart" deprecated="jetty.dump.start"
			default="false" />
	</Set>
	<Set name="dumpBeforeStop">
		<Property name="jetty.server.dumpBeforeStop" deprecated="jetty.dump.stop"
			default="false" />
	</Set>

	<!-- To configure Includes / Excludes for Cipher Suites or Protocols see 
		tweak-ssl.xml example at https://www.eclipse.org/jetty/documentation/current/configuring-ssl.html#configuring-sslcontextfactory-cipherSuites -->
	<New id="sslContextFactory" class="org.eclipse.jetty.util.ssl.SslContextFactory">
		<Set name="KeyStorePath">
			<Property name="jetty.sslContext.keyStorePath" deprecated="jetty.keystore" />
		</Set>
		<Set name="KeyStorePassword">
			<Property name="jetty.sslContext.keyStorePassword"
				deprecated="jetty.keystore.password" default="changeit" />
		</Set>
		<Set name="KeyStoreType">
			<Property name="jetty.sslContext.keyStoreType" default="JKS" />
		</Set>
		<Set name="KeyStoreProvider">
			<Property name="jetty.sslContext.keyStoreProvider" />
		</Set>
		<Set name="KeyManagerPassword">
			<Property name="jetty.sslContext.keyManagerPassword"
				deprecated="jetty.keymanager.password" default="changeit" />
		</Set>
		<Set name="TrustStorePath">
			<Property name="jetty.sslContext.trustStorePath" deprecated="jetty.truststore" />
		</Set>
		<Set name="TrustStorePassword">
			<Property name="jetty.sslContext.trustStorePassword"
				deprecated="jetty.truststore.password" default="changeit" />
		</Set>
		<Set name="TrustStoreType">
			<Property name="jetty.sslContext.trustStoreType" default="JKS" />
		</Set>
		<Set name="TrustStoreProvider">
			<Property name="jetty.sslContext.trustStoreProvider" />
		</Set>
		<Set name="EndpointIdentificationAlgorithm"></Set>
		<Set name="NeedClientAuth">
			<Property name="jetty.sslContext.needClientAuth" deprecated="jetty.ssl.needClientAuth"
				default="true" />
		</Set>
		<Set name="WantClientAuth">
			<Property name="jetty.sslContext.wantClientAuth" deprecated="jetty.ssl.wantClientAuth"
				default="true" />
		</Set>
		<Set name="useCipherSuitesOrder">
			<Property name="jetty.sslContext.useCipherSuitesOrder"
				default="true" />
		</Set>
		<Set name="sslSessionCacheSize">
			<Property name="jetty.sslContext.sslSessionCacheSize"
				default="-1" />
		</Set>
		<Set name="sslSessionTimeout">
			<Property name="jetty.sslContext.sslSessionTimeout" default="-1" />
		</Set>
	</New>

	<!-- =========================================================== -->
	<!-- Add a SSL Connector with no protocol factories -->
	<!-- =========================================================== -->
	<Call name="addConnector">
		<Arg>
			<New id="sslConnector" class="org.eclipse.jetty.server.ServerConnector">
				<Arg name="server">
					<Ref refid="Server" />
				</Arg>
				<Arg name="acceptors" type="int">
					<Property name="jetty.ssl.acceptors" deprecated="ssl.acceptors"
						default="-1" />
				</Arg>
				<Arg name="selectors" type="int">
					<Property name="jetty.ssl.selectors" deprecated="ssl.selectors"
						default="-1" />
				</Arg>
				<Arg name="factories">
					<Array type="org.eclipse.jetty.server.ConnectionFactory">
						<!-- uncomment to support proxy protocol <Item> <New class="org.eclipse.jetty.server.ProxyConnectionFactory"/> 
							</Item> -->
					</Array>
				</Arg>

				<Set name="host">
					<Property name="jetty.ssl.host" deprecated="jetty.host" />
				</Set>
				<Set name="port">
					<Property name="jetty.ssl.port" deprecated="ssl.port"
						default="8443" />
				</Set>
				<Set name="idleTimeout">
					<Property name="jetty.ssl.idleTimeout" deprecated="ssl.timeout"
						default="30000" />
				</Set>
				<Set name="soLingerTime">
					<Property name="jetty.ssl.soLingerTime" deprecated="ssl.soLingerTime"
						default="-1" />
				</Set>
				<Set name="acceptorPriorityDelta">
					<Property name="jetty.ssl.acceptorPriorityDelta"
						deprecated="ssl.acceptorPriorityDelta" default="0" />
				</Set>
				<Set name="acceptQueueSize">
					<Property name="jetty.ssl.acceptQueueSize" deprecated="ssl.acceptQueueSize"
						default="0" />
				</Set>
			</New>
		</Arg>
	</Call>

	<!-- =========================================================== -->
	<!-- Create a TLS specific HttpConfiguration based on the -->
	<!-- common HttpConfiguration defined in jetty.xml -->
	<!-- Add a SecureRequestCustomizer to extract certificate and -->
	<!-- session information -->
	<!-- =========================================================== -->
	<New id="sslHttpConfig" class="org.eclipse.jetty.server.HttpConfiguration">
		<Arg>
			<Ref refid="httpConfig" />
		</Arg>
		<Call name="addCustomizer">
			<Arg>
				<New class="org.eclipse.jetty.server.SecureRequestCustomizer">
					<Arg name="sniHostCheck" type="boolean">
						<Property name="jetty.ssl.sniHostCheck" default="true" />
					</Arg>
					<Arg name="stsMaxAgeSeconds" type="int">
						<Property name="jetty.ssl.stsMaxAgeSeconds" default="-1" />
					</Arg>
					<Arg name="stsIncludeSubdomains" type="boolean">
						<Property name="jetty.ssl.stsIncludeSubdomains" default="false" />
					</Arg>
				</New>
			</Arg>
		</Call>
	</New>

	<!-- ============================================================= -->
	<!-- Configure a HTTPS connector. -->
	<!-- This configuration must be used in conjunction with jetty.xml -->
	<!-- and jetty-ssl.xml. -->
	<!-- ============================================================= -->
	<Ref refid="sslConnector">
		<Call name="addIfAbsentConnectionFactory">
			<Arg>
				<New class="org.eclipse.jetty.server.SslConnectionFactory">
					<Arg name="next">http/1.1</Arg>
					<Arg name="sslContextFactory">
						<Ref refid="sslContextFactory" />
					</Arg>
				</New>
			</Arg>
		</Call>

		<Call name="addConnectionFactory">
			<Arg>
				<New class="org.eclipse.jetty.server.HttpConnectionFactory">
					<Arg name="config">
						<Ref refid="sslHttpConfig" />
					</Arg>
					<Arg name="compliance">
						<Call class="org.eclipse.jetty.http.HttpCompliance" name="valueOf">
							<Arg>
								<Property name="jetty.http.compliance" default="RFC7230" />
							</Arg>
						</Call>
					</Arg>
				</New>
			</Arg>
		</Call>
	</Ref>

	<!-- Configure Jetty to, you know, actually run the webapp. -->
	<New id="webAppContext" class="org.eclipse.jetty.webapp.WebAppContext">
		<!-- Configure the WAR to be run. -->
		<Arg name="webApp">
			<Property name="bbfhir.war.path" />
		</Arg>

		<!-- Configure the WAR to run at the root context, i.e. "/". -->
		<Arg name="contextPath">/</Arg>

		<!-- Enable some of the required configurators for this context. This is 
			derived from the docs here: http://www.eclipse.org/jetty/documentation/9.3.x/configuring-webapps.html. 
			Not exactly sure which of these are required, but I know from past experience 
			that at least WebInf and Annotation are. -->
		<Set name="configurationClasses">
			<Array type="java.lang.String">
				<Item>org.eclipse.jetty.webapp.WebInfConfiguration</Item>
				<Item>org.eclipse.jetty.annotations.AnnotationConfiguration</Item>
				<Item>org.eclipse.jetty.webapp.WebXmlConfiguration</Item>

				<!-- <Item>org.eclipse.jetty.webapp.MetaInfConfiguration</Item> <Item>org.eclipse.jetty.webapp.FragmentConfiguration</Item> 
					<Item>org.eclipse.jetty.plus.webapp.EnvConfiguration</Item> <Item>org.eclipse.jetty.plus.webapp.PlusConfiguration</Item> 
					<Item>org.eclipse.jetty.webapp.JettyWebXmlConfiguration</Item> -->
			</Array>
		</Set>
	</New>
	<Ref refid="Contexts">
		<Call name="addHandler">
			<Arg name="handler">
				<Ref refid="webAppContext" />
			</Arg>
		</Call>
	</Ref>

</Configure>
