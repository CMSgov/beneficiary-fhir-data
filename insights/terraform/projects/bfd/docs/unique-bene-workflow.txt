@startuml
database "Glue Catalog" {
  frame "api_requests" as api_requests {
  }
}

note right of api_requests
  Unified historical and incoming raw api data
end note

package "Cloud Watch" {
  [ Log Group\n(access.json) ] as L
  L --> () Export
  L --> () Subscription
}

note left of Export
   CW Exports have a very inconvenient format
   that do not match the subscription format.
   Furthermore they cannot be exported into
   S3 buckets that use KMS, so we have to have
   a separate process to ingest them. This should
   be an infrequent operation to initially populate
   historical data.
end note

package "Athena" {
  (Queries)
}

package "Kinesis Firehose" {
(Lambda)
}

Export --> Queries
Queries --> api_requests

Subscription --> (Lambda)
Lambda --> api_requests

note right of Lambda
  Flatten the JSON schema so that
  we have one column for each MDC
  structure field.
end note

package "Analysis" {
  [ Athena Views ] as A
  api_requests --> A
  A --> [ QuickSight ]
}

note right of A
  * Filter out non-200s
  * Reduce field selections
  * Pivot out bene_id arrays (one bene per record)
  * Aggregate benes_queried and first_seen date
end note

@enduml