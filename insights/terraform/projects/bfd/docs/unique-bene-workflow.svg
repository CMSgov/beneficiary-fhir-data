<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="780px" preserveAspectRatio="none" style="width:618px;height:780px;background:#FFFFFF;" version="1.1" viewBox="0 0 618 780" width="618px" zoomAndPan="magnify"><defs/><g><!--MD5=[c2dc1ddc239802de9bd2388d9adbf8a8]
cluster Glue Catalog--><g id="cluster_Glue Catalog"><path d="M70,432 C70,422 152,422 152,422 C152,422 234,422 234,432 L234,524 C234,534 152,534 152,534 C152,534 70,534 70,524 L70,432 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M70,432 C70,442 152,442 152,442 C152,442 234,442 234,432 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="104" x="100" y="456.9951">Glue Catalog</text></g><!--MD5=[227da6eda29c9985c7a36fc9f1032b07]
cluster Cloud Watch--><g id="cluster_Cloud Watch"><path d="M81.5,6 L184.5,6 A3.75,3.75 0 0 1 187,8.5 L194,28.2969 L267.5,28.2969 A2.5,2.5 0 0 1 270,30.7969 L270,264.5 A2.5,2.5 0 0 1 267.5,267 L81.5,267 A2.5,2.5 0 0 1 79,264.5 L79,8.5 A2.5,2.5 0 0 1 81.5,6 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="79" x2="194" y1="28.2969" y2="28.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="102" x="83" y="20.9951">Cloud Watch</text></g><!--MD5=[d2214bb73b5efd5a5666db485b6a9701]
cluster Athena--><g id="cluster_Athena"><path d="M8.5,318 L67.5,318 A3.75,3.75 0 0 1 70,320.5 L77,340.2969 L137.5,340.2969 A2.5,2.5 0 0 1 140,342.7969 L140,395.5 A2.5,2.5 0 0 1 137.5,398 L8.5,398 A2.5,2.5 0 0 1 6,395.5 L6,320.5 A2.5,2.5 0 0 1 8.5,318 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="6" x2="77" y1="340.2969" y2="340.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="58" x="10" y="332.9951">Athena</text></g><!--MD5=[d7bf45cf252ddd919235dd930d9f22c8]
cluster Kinesis Firehose--><g id="cluster_Kinesis Firehose"><path d="M166.5,318 L297.5,318 A3.75,3.75 0 0 1 300,320.5 L307,340.2969 L307.5,340.2969 A2.5,2.5 0 0 1 310,342.7969 L310,395.5 A2.5,2.5 0 0 1 307.5,398 L166.5,398 A2.5,2.5 0 0 1 164,395.5 L164,320.5 A2.5,2.5 0 0 1 166.5,318 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="164" x2="307" y1="340.2969" y2="340.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="130" x="168" y="332.9951">Kinesis Firehose</text></g><!--MD5=[0f1402dd4ba50f92b20010225714ea74]
cluster Analysis--><g id="cluster_Analysis"><path d="M65.5,558 L134.5,558 A3.75,3.75 0 0 1 137,560.5 L144,580.2969 L238.5,580.2969 A2.5,2.5 0 0 1 241,582.7969 L241,771 A2.5,2.5 0 0 1 238.5,773.5 L65.5,773.5 A2.5,2.5 0 0 1 63,771 L63,560.5 A2.5,2.5 0 0 1 65.5,558 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="63" x2="144" y1="580.2969" y2="580.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="68" x="67" y="572.9951">Analysis</text></g><!--MD5=[0c0421921575f52d5e605439b27fa137]
entity api_requests--><g id="elem_api_requests"><rect fill="#F1F1F1" height="46.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="131" x="86.5" y="472"/><path d="M130.1667,472 L130.1667,477 L123.1667,484 L86.5,484 " fill="none" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="101.5" y="504.9951">api_requests</text></g><!--MD5=[1200cabd2a84086424de0b397dfd2f71]
entity L--><g id="elem_L"><rect fill="#F1F1F1" height="62.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="135" x="106.5" y="41"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="221.5" y="46"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="219.5" y="48"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="219.5" y="52"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="125.5" y="73.9951">Log Group</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="121.5" y="90.292">(access.json)</text></g><!--MD5=[4a52932e87c05afea63f6d60a0835fd7]
entity Subscription--><g id="elem_Subscription"><ellipse cx="201" cy="222" fill="#F1F1F1" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="155.5" y="251.9951">Subscription</text></g><!--MD5=[4f8ceaf617da225fb01a8e9682419e55]
entity Export--><g id="elem_Export"><ellipse cx="104" cy="222" fill="#F1F1F1" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="49" x="79.5" y="251.9951">Export</text></g><g id="elem_Queries"><ellipse cx="72.8615" cy="367.6946" fill="#F1F1F1" rx="50.3615" ry="14.6946" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="54" x="42.8615" y="371.4422">Queries</text></g><g id="elem_Lambda"><ellipse cx="233.1007" cy="367.715" fill="#F1F1F1" rx="52.6007" ry="14.715" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="57" x="201.6007" y="371.4626">Lambda</text></g><!--MD5=[770389ab9df153645bc6ef28055eb2b5]
entity A--><g id="elem_A"><rect fill="#F1F1F1" height="46.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="79.5" y="593"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="204.5" y="598"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="202.5" y="600"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="202.5" y="604"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="97" x="98.5" y="625.9951">Athena Views</text></g><!--MD5=[00ec4551a9636032c33b95aee0b982ec]
entity  QuickSight --><g id="elem_ QuickSight "><rect fill="#F1F1F1" height="46.2969" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="126" x="89" y="711.5"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="195" y="716.5"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="193" y="718.5"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="193" y="722.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="108" y="744.4951">QuickSight</text></g><g id="elem_GMN1162726"><path d="M253,482.5 L253,507.6328 L553,507.6328 L553,492.5 L543,482.5 L253,482.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M543,482.5 L543,492.5 L553,492.5 L543,482.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="279" x="259" y="499.5669">Unified historical and incoming raw api data</text></g><g id="elem_GMN1162735"><path d="M289,164 L289,279.9297 L611,279.9297 L611,174 L601,164 L289,164 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M601,164 L601,174 L611,174 L601,164 " fill="#FEFFDD" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="290" x="295" y="181.0669">CW Exports have a very inconvenient format</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="274" x="295" y="196.1997">that do not match the subscription format.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="271" x="295" y="211.3325">Furthermore they cannot be exported into</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292" x="295" y="226.4653">S3 buckets that use KMS, so we have to have</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="301" x="295" y="241.5981">a separate process to ingest them. This should</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="295" y="256.731">be an infrequent operation to initially populate</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="295" y="271.8638">historical data.</text></g><g id="elem_GMN1162746"><path d="M326.5,340 L326.5,363.5 L285.734,367.5 L326.5,371.5 L326.5,395.3984 A0,0 0 0 0 326.5,395.3984 L571.5,395.3984 A0,0 0 0 0 571.5,395.3984 L571.5,350 L561.5,340 L326.5,340 A0,0 0 0 0 326.5,340 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M561.5,340 L561.5,350 L571.5,350 L561.5,340 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="208" x="332.5" y="357.0669">Flatten the JSON schema so that</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="224" x="332.5" y="372.1997">we have one column for each MDC</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="332.5" y="387.3325">structure field.</text></g><g id="elem_GMN1162754"><path d="M260,580.5 L260,612 L224.51,616 L260,620 L260,651.0313 A0,0 0 0 0 260,651.0313 L594,651.0313 A0,0 0 0 0 594,651.0313 L594,590.5 L584,580.5 L260,580.5 A0,0 0 0 0 260,580.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M584,580.5 L584,590.5 L594,590.5 L584,580.5 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><ellipse cx="271.5" cy="593.1328" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="279" y="597.5669">Filter out non-200s</text><ellipse cx="271.5" cy="608.2656" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="147" x="279" y="612.6997">Reduce field selections</text><ellipse cx="271.5" cy="623.3984" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="300" x="279" y="627.8325">Pivot out bene_id arrays (one bene per record)</text><ellipse cx="271.5" cy="638.5313" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="293" x="279" y="642.9653">Aggregate benes_queried and first_seen date</text></g><!--MD5=[7186a9aa64c0c06ecba4068b0eacbbb9]
link api_requests to GMN1162726--><g id="link_api_requests_GMN1162726"><path d="M217.691,495 C229.394,495 241.096,495 252.799,495 " fill="none" id="api_requests-GMN1162726" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/></g><!--MD5=[7d62cf6410dc5ab0b027549eac00cede]
link L to Subscription--><g id="link_L_Subscription"><path d="M179.594,104.062 C185.429,135.935 194.305,184.424 198.559,207.666 " fill="none" id="L-to-Subscription" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="199.489,212.747,201.8033,203.1739,198.5888,207.8287,193.934,204.6142,199.489,212.747" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[13d3850150c6d7eb9c77f8bedc1ebe53]
link L to Export--><g id="link_L_Export"><path d="M159.461,104.076 C151.126,121.612 140.469,144.04 131,164 C123.772,179.235 115.47,196.768 110.001,208.32 " fill="none" id="L-to-Export" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="107.842,212.881,115.3076,206.4573,109.981,208.3616,108.0766,203.0349,107.842,212.881" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[88e5b723a424d72f4f1a9082e49e7117]
link GMN1162735 to Export--><g id="link_GMN1162735_Export"><path d="M341.517,163.95 C313.312,151.596 282.424,140.365 252.5,134 C207.289,124.383 188.581,110.979 148.5,134 C119.254,150.798 108.668,193.854 105.341,212.809 " fill="none" id="GMN1162735-Export" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/></g><!--MD5=[3f04481cee619b48fad5b93ed0c9b42e]
link Export to Queries--><g id="link_Export_Queries"><path d="M102.244,231.126 C97.426,253.433 83.8974,316.055 77.0618,347.698 " fill="none" id="Export-to-Queries" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="75.9457,352.864,81.7558,344.9115,77.0014,347.9767,73.9362,343.2223,75.9457,352.864" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[d4c7cd46bcfa186dd09f43f95c675771]
link Queries to api_requests--><g id="link_Queries_api_requests"><path d="M81.4544,381.931 C94.248,402.254 118.779,441.224 135.269,467.422 " fill="none" id="Queries-to-api_requests" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="138.047,471.834,136.6365,462.0867,135.3829,467.6029,129.8667,466.3492,138.047,471.834" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[81a849ca3791a4a54d46d7afc6f4aea5]
link Subscription to Lambda--><g id="link_Subscription_Lambda"><path d="M202.812,231.126 C207.787,253.433 221.751,316.055 228.807,347.698 " fill="none" id="Subscription-to-Lambda" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="229.959,352.864,231.9036,343.209,228.8704,347.9839,224.0955,344.9508,229.959,352.864" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[0eacc5fe3bd22f785a86d33c91773850]
link Lambda to api_requests--><g id="link_Lambda_api_requests"><path d="M224.332,381.931 C211.214,402.254 186.062,441.224 169.154,467.422 " fill="none" id="Lambda-to-api_requests" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="166.306,471.834,174.5471,466.441,169.0172,467.6329,167.8253,462.103,166.306,471.834" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[e474f68b911554ad96633415d9be8081]
link api_requests to A--><g id="link_api_requests_A"><path d="M152,518.104 C152,537.685 152,566.351 152,587.426 " fill="none" id="api_requests-to-A" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="152,592.61,156,583.61,152,587.61,148,583.61,152,592.61" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[c58130d1eb586e0c9e061c6597e577f0]
link A to  QuickSight --><g id="link_A_ QuickSight "><path d="M152,639.187 C152,658.297 152,685.945 152,706.3685 " fill="none" id="A-to- QuickSight " style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="152,711.3956,156,702.3956,152,706.3956,148,702.3956,152,711.3956" style="stroke:#181818;stroke-width:1.0;"/></g><!--MD5=[f20e993fabb0cc4a47a2d5eeb7f1f611]
@startuml
database "Glue Catalog" {
  frame "api_requests" as api_requests {
  }
}

note right of api_requests
  Unified historical and incoming raw api data
end note

package "Cloud Watch" {
  [ Log Group\n(access.json) ] as L
  L - -> () Subscription
  L - -> () Export
}

note left of Export
   CW Exports have a very inconvenient format
   that do not match the subscription format.
   Furthermore they cannot be exported into
   S3 buckets that use KMS, so we have to have
   a separate process to ingest them. This should
   be an infrequent operation to initially populate
   historical data.
end note

package "Athena" {
  (Queries)
}

package "Kinesis Firehose" {
(Lambda)
}

Export - -> Queries
Queries - -> api_requests

Subscription - -> (Lambda)
Lambda - -> api_requests

note right of Lambda
  Flatten the JSON schema so that
  we have one column for each MDC
  structure field.
end note

package "Analysis" {
  [ Athena Views ] as A
  api_requests - -> A
  A - -> [ QuickSight ]
}

note right of A
  * Filter out non-200s
  * Reduce field selections
  * Pivot out bene_id arrays (one bene per record)
  * Aggregate benes_queried and first_seen date
end note
@enduml

PlantUML version 1.2022.8beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>