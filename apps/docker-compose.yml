version: '3'

services:
  bfd:
    build:
      context: .
      dockerfile: Dockerfile.local
    command: >
      bash -c "mkdir -p .github/scripts && touch .github/scripts/pre-push.sh && touch .github/scripts/pre-commit.sh &&
               cd /apps && export PROJ_VER=`mvn help:evaluate -Dexpression=project.version -q -DforceStdout` &&
               export BFD_PATHS_FILES_WAR=$${BFD_SVR_WAR_DIR}bfd-server-war-$${PROJ_VER}.war &&
               cp toolchains.xml ~/.m2/ && mvn install -Dgitbuildhook.skip=true -DskipITs -DskipTests=true &&
               export CLASSPATH=$${BFD_MIGRATOR_DIR}/bfd-db-migrator-$${PROJ_VER}/lib/*:$${BFD_MIGRATOR_DIR}/bfd-db-migrator-$${PROJ_VER}/bfd-db-migrator-$${PROJ_VER}.jar &&
               echo $${CLASSPATH} &&
               java -Xms512m -Xmx512m -Dorg.jboss.logging.provider=slf4j gov.cms.bfd.migrator.app.MigratorApp &&
               export CLASSPATH=$${BFD_SVR_LAUNCHER_DIR}/bfd-server-launcher-$${PROJ_VER}/lib/*:$${BFD_SVR_LAUNCHER_DIR}/bfd-server-launcher-$${PROJ_VER}/bfd-server-launcher-$${PROJ_VER}.jar &&
               echo $${CLASSPATH} &&
               java -Xms4g -Xmx4g -Dorg.jboss.logging.provider=slf4j -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005 gov.cms.bfd.server.launcher.DataServerLauncherApp"
    environment:
      - BFD_ENV_NAME=laptop
      - BFD_DB_URL=jdbc:postgresql://db:5432/fhirdb
      - BFD_DB_USERNAME=bfd
      - BFD_DB_PASSWORD=InsecureLocalDev
      - BFD_PATHS_FILES_TRUSTSTORE=./bfd-server/dev/ssl-stores/server-truststore.pfx
      - BFD_PATHS_FILES_KEYSTORE=./bfd-server/dev/ssl-stores/server-keystore.pfx
      - BFD_SVR_WAR_DIR=./bfd-server/bfd-server-war/target/
      - BFD_MIGRATOR_DIR=./bfd-db-migrator/target/db-migrator/
      - BFD_SVR_LAUNCHER_DIR=./bfd-server/bfd-server-launcher/target/server-work/
      - BFD_PORT=6500
      - BFD_PAC_ENABLED=true
      - BFD_PAC_CLAIM_SOURCE_TYPES=fiss,mcs
    volumes:
      - ./:/apps
    ports:
      - "6500:6500"
      - "5005:5005"
    depends_on:
      - db
  db:
    image: postgres:14
    environment:
      - POSTGRES_USER=bfd
      - POSTGRES_DB=fhirdb
      - POSTGRES_PASSWORD=InsecureLocalDev
    volumes:
      - bfd-db:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -d postgres" ]
      interval: 30s
      timeout: 10s
      retries: 5
volumes:
  bfd-db:
