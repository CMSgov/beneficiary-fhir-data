//See this link for lexer order -> https://github.com/hapifhir/org.hl7.fhir.core/blob/c06051838f9bcd5fc0b552df960f5bf2fcf2dbb4/org.hl7.fhir.r4/src/main/java/org/hl7/fhir/r4/utils/StructureMapUtilities.java#L757
//Must appear in order map -> conceptmap -> uses -> imports -> groups

map "https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Base" = "BFD-ExplanationOfBenefit-Base-Map"

uses "https://bfd.cms.gov/fhir/StructureDefinition/ExplanationOfBenefit-Base" alias ExplanationOfBenefitBase as source
//hl7.org urls are used for dependent resources as the FHIR validator resolves them as such. 
uses "http://hl7.org/fhir/StructureDefinition/ProcedureComponent" alias ProcedureComponent as source
uses "http://hl7.org/fhir/StructureDefinition/DiagnosisComponent" alias DiagnosisComponent as source
uses "http://hl7.org/fhir/StructureDefinition/SupportingInfoComponent" alias SupportingInfoComponent as source
uses "http://hl7.org/fhir/StructureDefinition/LineItemComponent" alias LineItemComponent as source
uses "http://hl7.org/fhir/StructureDefinition/CareTeamComponent" alias CareTeamComponent as source
uses "http://hl7.org/fhir/StructureDefinition/Provider" alias ProviderComponent as source


//The first specified target is what the default output will output as the ResourceType
uses "http://hl7.org/fhir/StructureDefinition/ExplanationOfBenefit" alias BFDEOB as target

imports "https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper" 
imports "https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-SupportingInfo-Helper" 
imports "https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Item-Institutional-Helper" 

group createEOBBase(source src: ExplanationOfBenefitBase, target tgt: BFDEOB){
    
    src -> tgt.status = "active" "Set status";
    //CLM_LTST_CLM_IND = latest claim indicator
    //CLM_FINL_ACTN_IND = claim is done processing
    //CLM_CNTL_NUM = claim control number
    //ORIG_CLM_CNTL_NUM = original claim control number. subsumes previous ones. 

    src -> tgt.use = "claim" "Set use code";
    src -> tgt.type = create('CodeableConcept') as tgtCC then {
      //CodeSystem -> CLM_TYPE_CD
      src.CLM_TYPE_CD as typeCd -> tgtCC.coding = translate(typeCd,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#CLM_TYPE_CD','coding') "translate code";
      src.CLM_TYPE_CD as typeCd -> tgtCC.coding = c('https://bluebutton.cms.gov/fhir/CodeSystem/CLM-TYPE-CD', typeCd) "Add claim type code";
    } "Create type";

    src -> tgt.subType = create('CodeableConcept') as tgtCC then {
      src.CLM_TYPE_CD as typeCd -> tgtCC.coding = translate(typeCd,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#subtype','coding') "translate code";
    } "Create type";

    src -> tgt.patient = create('Reference') as tgtReference then {
      src.CLM_BENE_XREF_EFCTV_SK as ptId -> tgtReference.reference = append("Patient/",ptId) "Concatenate patient id";
    } "Add patient reference to EOB";

    src -> tgt.meta = create('Meta') as tgtMeta then {
      src.lastUpdated as lastUpdated -> tgtMeta.lastUpdated = lastUpdated "set lastUpdated";
      src.CLM_TYPE_CD as typeCd -> tgtMeta.profile = translate(typeCd,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#profile_metadata','code') "set profile";
      //CodeSystem -> CLM_SRC_ID
      src.META_SRC_SK as sourceSk -> tgtMeta.source = translate(sourceSk, 'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#META_SRC_SK','code') "set source";
      src.CLM_SRC_ID as sourceSk -> tgtMeta.tag = translate(sourceSk, 'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#SYSTEM_TYPE','coding') "set source";
      src.CLM_FINL_ACTN_IND as faInd -> tgtMeta.tag = translate(faInd, 'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#FINAL_ACTION','coding') "set source";
    } "Create metadata";

    //add unique claim ID as one identifier. We will add multiple.
    src -> tgt.identifier = create('Identifier') as tgtIdentifier then {
          src -> tgtIdentifier.type = cc("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBIdentifierType", "uc") "Add identifier type";
          src.CLM_UNIQ_ID as claimId -> tgtIdentifier.value = claimId "Set identifier Value";
    } "Add CLM_UNIQ_ID as unique identifier";

    //CLM_CNTL_NUM  
    src -> tgt.identifier = create('Identifier') as tgtIdentifier then {
      src -> tgtIdentifier.system = "https://bluebutton.cms.gov/identifiers/CLM-CNTL-NUM" "set system";
      src.CLM_CNTL_NUM as claimCntlNum -> tgtIdentifier.value = claimCntlNum "Set identifier Value";
    } "Add CLM_CNTL_NUM as identifier";

    src.clmCntlArray as otherClaimNumber -> tgt.related = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.relationship = cc("http://terminology.hl7.org/CodeSystem/ex-relatedclaimrelationship","prior") "Add relationshipp";
      src -> tgtBBElement.reference = create('Identifier') as tgtId then{
        src -> tgtId.system = "https://bluebutton.cms.gov/identifiers/CLM-CNTL-NUM" "Add system";
        src -> tgtId.value = otherClaimNumber "Add value";
      } "Add reference";
    } "Add other claim control numbers";

    src -> tgt.billablePeriod = create('Period') as billablePeriod then {
      src.CLM_FROM_DT as fromDate -> billablePeriod.start = fromDate "Set from date";
      src.CLM_THRU_DT as toDate -> billablePeriod.end = toDate "Set to date";
    } "Set EOB period";
    
    src.CLM_EFCTV_DT as efctvDate -> tgt.created = efctvDate "Add created date for EOB";

    //Set insurer for part A + B claims. MA starts at 4XXX
    src.CLM_TYPE_CD as typeCd where (typeCd > 4 and typeCd < 4000) -> tgt.contained = create('Organization') as tgtOrg then createInsurerOrgPartAB(src,tgtOrg) "Create insurer org.";
    src.CLM_TYPE_CD as typeCd where (typeCd > 4 and typeCd < 4000) -> tgt.insurer = create('Reference') as tgtOrgRef, 
    tgtOrgRef.reference = "#insurer-org" "Set reference to contained insurer org";

    src.CLM_PMT_AMT as amt -> tgt.payment = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amt, tgtMoney) "Add Money";
    } "CLM_PMT_AMT";

    src.PRVDR_BLG_PRVDR_NPI_NUM as blgNPI -> tgt then{
      //We don't populate careTeamType when it's the provider, so we can uniquely identify it as billing.
        src -> tgt.provider = create('Reference') as tgtRef, tgtRef.reference = append("#", blgNPI) "Add reference to NPI";
        src.providerList as provider where provider.isDuplicate.exists().not() and provider.careTeamType.exists().not() and provider.NPI_TYPE = 1 -> tgt.contained = create('Practitioner') as tgtPract then createPractitioner(provider, tgtPract) "Add Practitioner";
        src.providerList as provider where provider.isDuplicate.exists().not() and provider.careTeamType.exists().not() and provider.NPI_TYPE = 2 -> tgt.contained = create('Organization') as tgtOrg then createOrg(provider, tgtOrg) "Add Organization";
    } "Add billing provider";
   
    //Partial for PAC data, complete for adjudicated. Of note, we do this by source. So even if final action on PAC source, still "partial"
    src.CLM_SRC_ID as sourceSk where sourceSk = '20000' -> tgt.outcome = "complete" "Set NCH outcome to complete.";
    src.CLM_TYPE_CD as typeCd where(typeCd >= 1000 and typeCd < 2000) -> tgt.outcome = "partial" "Add phase 1 outcome";
    //Check on 1000-2000 phases w/ the CLM_CRNT_STUS_CD. We can 
    src.CLM_TYPE_CD as typeCd where(typeCd >= 2000 and typeCd < 3000) -> tgt then {
      //Bifurcate by if it's institutional or professional. 
      src.institutionalComponents as instComponents -> tgt then {
        instComponents.CLM_CRNT_STUS_CD as curStatusCode -> tgt.outcome = translate(curStatusCode, 'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#CLM-CRNT-STUS-CD','code') "Set outcome for phase 2/3 FISS";
      } "Set institutional outcome";

      src.profComponents as profComponents -> tgt then {
        profComponents.CLM_AUDT_TRL_STUS_CD as auditTrailStatusCode -> tgt.outcome = translate(auditTrailStatusCode, 'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#CLM_AUDT_TRL_STUS_CD','code') "Set outcome for phase 2/3 MCS";
      } "Set professional outcome";
    } "Complete additional outcomes";
    //When we get to carrier/DME, we'll do the same with MCS/VMS status. 

    //Building out procedure, diagnosis, supportingInfo, item, and then careteam

    //procedure
    src.procedures as procedures -> tgt.procedure = create('BackboneElement') as tgtProcedure then addProcedures(procedures, tgtProcedure) "Add procedures to inpatient institutional EOBs";

    //diagnosis
    src.CLM_TYPE_CD as typeCd where((typeCd > 4 and typeCd < 70) or (typeCd >= 2000 and typeCd < 2700) or (typeCd >= 1000 and typeCd < 1700) or typeCd = 2900) -> tgt then{
      src.diagnoses as diagnoses -> tgt.diagnosis = create('BackboneElement') as tgtDiagnosis then addDiagnoses(diagnoses, tgtDiagnosis) "Add diagnoses";
    } "Add diagnoses for institutional claims.";

    src.CLM_TYPE_CD as typeCd where((typeCd > 70 and typeCd <= 82) or (typeCd >= 2700 and typeCd < 2900) or (typeCd >= 1700 and typeCd < 1900)) -> tgt then{
      src.diagnoses as diagnoses -> tgt.diagnosis = create('BackboneElement') as tgtDiagnosis then addDiagnosesProfessional(diagnoses, tgtDiagnosis) "Add diagnoses";
    } "Add diagnoses for institutional claims.";
    

    //Supportinginfo!
    src.supportingInfoComponents as infoComponent -> tgt.supportingInfo = create('BackboneElement') as tgtSupportingInfo then addSupportingInfo(infoComponent,tgtSupportingInfo) "add supportingInfo";

    //This will end up being for adjudicated only for now. The "type" is available in CLM_LINE_MCS, which we do not consume for now. 
    src.supportingInfoComponents as suppComponent where suppComponent.CLM_LINE_HCT_HGB_TYPE_CD.exists() -> tgt.contained = create('Observation') as tgtObs then{
      suppComponent.ROW_NUM as rowNum -> tgtObs.id = append("line-observation-",rowNum) "Add id";
      suppComponent.CLM_LINE_HCT_HGB_TYPE_CD as hctType where hctType = 'R1' -> tgtObs.code = cc("http://loinc.org","718-7") "Add code for Hemoglobin";
      suppComponent.CLM_LINE_HCT_HGB_TYPE_CD as hctType where hctType = 'R2' -> tgtObs.code = cc("http://loinc.org","4544-3") "Add code for Hematocrit";
      suppComponent.CLM_LINE_HCT_HGB_RSLT_NUM as rslt -> tgtObs.value = rslt "Add result value";
      src -> tgtObs.status = "final" "Add final status";
      suppComponent.CLM_LINE_CARR_CLNCL_LAB_NUM as cliaNum -> tgtObs.performer = create('Reference') as tgtRef then{
        cliaNum -> tgtRef.identifier = create('Identifier') as tgtIdentifier, tgtIdentifier.system="http://terminology.hl7.org/NamingSystem/CLIA",tgtIdentifier.value=cliaNum "Add CLIA Num";
      } "Add performing lab";
      
    } "Added observation";

    //item
    src.lineItemComponents as itemComp -> tgt.item = create('BackboneElement') as tgtItem then {
      // Map the standard item fields
      itemComp -> tgtItem then addItem(itemComp, tgtItem) "Add Item";

      itemComp.CLM_LINE_PA_UNIQ_TRKNG_NUM as val -> tgt.supportingInfo as tgtSI then
        addPAUTNSupportingInfo(itemComp, tgtSI);

      itemComp.CLM_LINE_PMD_UNIQ_TRKNG_NUM as val -> tgt.supportingInfo as tgtSI then
        addPMDUTNSupportingInfo(itemComp, tgtSI);

    } "Create Item and SupportingInfo";

    //There may be instances where, for example, the attending and the operating provider are the same (or some other permutation).
    //In these instances, the FML will product duplicate contained resources. We do not actually want to populate dual identical resources, so they're filtered out by the compilation script.
    src.providerList as pList where pList.careTeamType.exists() -> tgt then {
      pList where pList.NPI_TYPE = 1 and pList.isDuplicate.exists().not() -> tgt.contained = create('Practitioner') as tgtPract then createPractitioner(pList, tgtPract) "Add Practitioner";
      pList where pList.NPI_TYPE = 2 and pList.isDuplicate.exists().not() -> tgt.contained = create('Organization') as tgtOrg then createOrg(pList, tgtOrg) "Add Organization";

      src -> tgt.careTeam = create('BackboneElement') as tgtBBElement then {
        pList.careTeamType as careTeamType -> tgtBBElement.role = cc("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBClaimCareTeamRole", careTeamType) "Add role";
        pList.careTeamSequenceNumber as seqNum -> tgtBBElement.sequence = seqNum "Set sequence";
        src -> tgtBBElement.provider = create('Reference') as tgtReference then {
          pList.PRVDR_SK as npi -> tgtReference.reference = append("#", npi) "Add reference";
        } "Add reference to EOB";
        
        pList.taxonomyCodes as taxonomyCodes -> tgtBBElement.qualification = create('CodeableConcept') as qualCC then{
          taxonomyCodes -> qualCC.coding = c("http://nucc.org/provider-taxonomy", taxonomyCodes) "add taxonomy";
        } "Add taxonomy/qualifications";
      } "Add CareTeam Element";

    } "Add CareTeam providers";

    //Add header level adjudication.
    src -> tgt.adjudication = create('BackboneElement') as tgtAdjudication then {
      src -> tgtAdjudication.reason = cc("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBPayerAdjudicationStatus","other") "Set adjudication reason";
      src -> tgtAdjudication.category = cc("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudicationDiscriminator","benefitpaymentstatus") "Set adjudication category";
    } "Add header-level adjudication";

    src.institutionalComponents as institutionalComponents -> tgt as instlTgt then addInstitutionalAdjudicationElements(src, instlTgt) "add institutional components to adjudication";


    src.profComponents as profComponents -> tgt as profTgt then addProfessionalItems(src, profTgt) "Add professional components";
    
    src.CLM_TYPE_CD as claimType -> tgt.insurance = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.focal = true "Add focal";
      src -> tgtBBElement.coverage = create('Reference') as tgtReference then {
        src.supportingInfoComponents as suppInfo where suppInfo.CLM_NRLN_RIC_CD.exists() or suppInfo.CLM_RIC_CD.exists() -> tgt then{
          suppInfo.CLM_NRLN_RIC_CD as nearLineAdjudicated -> tgtReference.display = translate(nearLineAdjudicated,"https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#RIC_CD",'code') "Add coverage type";
          suppInfo.CLM_RIC_CD as nearLinePartiallyAdjudicated -> tgtReference.display = translate(nearLinePartiallyAdjudicated,"https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#RIC_CD",'code') "Add coverage type";
        } "add insurance";
        //CLM_RIC_CD not in MCS/VMS :shrug:
        claimType where claimType = '1700' or claimType = '1800' or claimType = '2700' or claimType = '2800' -> tgtReference.display = "Part B" "Set part B for PAC Carrier/DME";
      } "Add reference for coverage";
    } "Add insurance coverage";

    //CLM_MDCR_INSTNL_TOT_CHRG_AMT -> CLM_SBMT_CHRG_AMT
    src.CLM_SBMT_CHRG_AMT as totChargeAmt -> tgt.total = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://terminology.hl7.org/CodeSystem/adjudication", "submitted") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_SBMT_CHRG_AMT") "Add second coding";
     } "Add codeable concept";
     src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(totChargeAmt, tgtMoney) "Add Money";
    } "Add total charge amount";

    src.CLM_ALOWD_CHRG_AMT as totChargeAmt -> tgt.total = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://terminology.hl7.org/CodeSystem/adjudication", "eligible") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_ALOWD_CHRG_AMT") "Add second coding";
     } "Add codeable concept";
     src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(totChargeAmt, tgtMoney) "Add Money";
    } "Add total charge amount";

    src.CLM_BENE_PMT_AMT as totChargeAmt -> tgt.total = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "paidbypatient") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_BENE_PMT_AMT") "Add second coding";
     } "Add codeable concept";
     src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(totChargeAmt, tgtMoney) "Add Money";
    } "Add charge amount";

    src.CLM_BENE_PD_AMT as totChargeAmt -> tgt.total = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "paidtopatient") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_BENE_PD_AMT") "Add second coding";
     } "Add codeable concept";
     src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(totChargeAmt, tgtMoney) "Add Money";
    } "Add clm_bene_pd_amt amount";
    //For institutional claims, this has to be sourced from the institutionalComponents because CLM_BENE_PD_AMT is not populated. 
    //Regardless, we use CLM_BENE_PD_AMT to condense the number of elements in the BB Adjudication CodeSystem
    src.institutionalComponents as institutionalComponents where institutionalComponents.CLM_MDCR_INSTNL_BENE_PD_AMT.exists() -> tgt.total = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "paidtopatient") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_BENE_PD_AMT") "Add second coding";
     } "Add codeable concept";
     institutionalComponents.CLM_MDCR_INSTNL_BENE_PD_AMT as totChgAmt -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(totChgAmt, tgtMoney) "Add Money";
    } "Add clm_bene_pd_amt amount";

    src.CLM_PRVDR_PMT_AMT as totChargeAmt -> tgt.total = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "paidtoprovider") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_PRVDR_PMT_AMT") "Add second coding";
     } "Add codeable concept";
     src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(totChargeAmt, tgtMoney) "Add Money";
    } "Add total charge amount";
  
    //for all practical purposes, these will only be present on institutional claims. 
  src.CLM_OPRTNL_DSPRTNT_AMT as amt -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_OPRTNL_DSPRTNT_AMT") "Add url";
      src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amt, tgtMoney) "Add Money";
    } "CLM_OPRTNL_DSPRTNT_AMT";

  src.CLM_OPRTNL_IME_AMT as amt -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_OPRTNL_IME_AMT") "Add url";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amt, tgtMoney) "Add Money";
  } "CLM_OPRTNL_IME_AMT";

  //CLM_MDCR_DDCTBL_AMT
  src.CLM_MDCR_DDCTBL_AMT as amtUsed -> tgt.total = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://terminology.hl7.org/CodeSystem/adjudication", "deductible") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_MDCR_DDCTBL_AMT") "Add second coding";
     } "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_DDCTBL_AMT";

  //CLM_MDCR_COINSRNC_AMT
  src.CLM_MDCR_COINSRNC_AMT as amtUsed -> tgt.total = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "coinsurance") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_MDCR_COINSRNC_AMT") "Add second coding";
     } "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_COINSRNC_AMT";
  
  //CLM_BLOOD_LBLTY_AMT
  src.CLM_BLOOD_LBLTY_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_BLOOD_LBLTY_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_BLOOD_LBLTY_AMT";

  //CLM_NCVRD_CHRG_AMT
  //http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication noncovered
  src.CLM_NCVRD_CHRG_AMT as amtUsed -> tgt.total = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "noncovered") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_NCVRD_CHRG_AMT") "Add second coding";
     } "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_NCVRD_CHRG_AMT";

  //CLM_BENE_INTRST_PD_AMT
  src.CLM_BENE_INTRST_PD_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_BENE_INTRST_PD_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_BENE_INTRST_PD_AMT";
  
  //CLM_BENE_PMT_COINSRNC_AMT
  src.CLM_BENE_PMT_COINSRNC_AMT as amtUsed -> tgt.total = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "coinsurance") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_BENE_PMT_COINSRNC_AMT") "Add second coding";
     } "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_BENE_PMT_COINSRNC_AMT";
  
  //CLM_BLOOD_CHRG_AMT
  src.CLM_BLOOD_CHRG_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_BLOOD_CHRG_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_BLOOD_CHRG_AMT";
  
  //CLM_BLOOD_NCVRD_CHRG_AMT
  src.CLM_BLOOD_NCVRD_CHRG_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_BLOOD_NCVRD_CHRG_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_BLOOD_NCVRD_CHRG_AMT";
  
  //CLM_COB_PTNT_RESP_AMT
  src.CLM_COB_PTNT_RESP_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_COB_PTNT_RESP_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_COB_PTNT_RESP_AMT";
  
  //CLM_OTHR_TP_PD_AMT
  src.CLM_OTHR_TP_PD_AMT as amtUsed -> tgt.total = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBAdjudication", "priorpayerpaid") "Add first coding";
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_OTHR_TP_PD_AMT") "Add second coding";
     } "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_OTHR_TP_PD_AMT";
  
  //CLM_PRVDR_INTRST_PD_AMT 
  src.CLM_PRVDR_INTRST_PD_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_PRVDR_INTRST_PD_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_PRVDR_INTRST_PD_AMT";
  
  //CLM_PRVDR_OTAF_AMT
  src.CLM_PRVDR_OTAF_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_PRVDR_OTAF_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_PRVDR_OTAF_AMT";
  
  //CLM_PRVDR_RMNG_DUE_AMT
  src.CLM_PRVDR_RMNG_DUE_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_PRVDR_RMNG_DUE_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_PRVDR_RMNG_DUE_AMT";
  
  //CLM_TOT_CNTRCTL_AMT
  src.CLM_TOT_CNTRCTL_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_TOT_CNTRCTL_AMT") "Add CC";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_TOT_CNTRCTL_AMT";
}

group addProfessionalItems(source src: ExplanationOfBenefitBase, target tgt: BFDEOB){
  
  //So we can source the components 
  src.profComponents as profComponents -> tgt then {
    profComponents.CLM_MDCR_PRFNL_PRMRY_PYR_AMT as chgAmt -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = create('CodeableConcept') as tgtCC then {
        src -> tgtCC.coding = c("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication", "CLM_MDCR_PRFNL_PRMRY_PYR_AMT") "Add second coding";
     } "Add codeable concept";
     src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(chgAmt, tgtMoney) "Add Money";
    } "Add total charge amount";

    profComponents.CLM_PRVDR_ACNT_RCVBL_OFST_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_PRVDR_ACNT_RCVBL_OFST_AMT") "Add CC";
      src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
    } "Add CLM_PRVDR_ACNT_RCVBL_OFST_AMT";  

  } "Add professional components.";

}

group addMoney(source src: String, target tgt: Money){
  src -> tgt.currency = "USD" "Set Currency";
  src as amt -> tgt.value = cast(amt, "decimal") "Set amount";
}

//These were previously in benefitBalance. After evaluating standard components in C4BB adjudication vs. CMS-specific elements, they've been re-organized to header-level adjudication elements.
group addInstitutionalAdjudicationElements(source src: ExplanationOfBenefitBase, target tgt: BackboneElement){
  src.institutionalComponents as institutionalComponents -> tgt then {
    institutionalComponents.CLM_MDCR_IP_LRD_USE_CNT as lrdUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_LRD_USE_CNT") "Add codeable concept";
      lrdUsed -> tgtBBElement.value = cast(lrdUsed,'unsignedInt') "set lrdUsed";
    } "Add CLM_MDCR_IP_LRD_USE_CNT";
    institutionalComponents.CLM_INSTNL_MDCR_COINS_DAY_CNT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_INSTNL_MDCR_COINS_DAY_CNT") "Add codeable concept";
     amtUsed -> tgtBBElement.value = cast(amtUsed,'unsignedInt') "set amtUsed";
    } "Add CLM_INSTNL_MDCR_COINS_DAY_CNT";
    institutionalComponents.CLM_INSTNL_NCVRD_DAY_CNT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
      src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_INSTNL_NCVRD_DAY_CNT") "Add codeable concept";
      amtUsed -> tgtBBElement.value = cast(amtUsed,'unsignedInt') "set amtUsed";
  } "Add CLM_INSTNL_NCVRD_DAY_CNT";
  institutionalComponents.CLM_MDCR_HOSPC_PRD_CNT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_HOSPC_PRD_CNT") "Add codeable concept";
    amtUsed -> tgtBBElement.value = cast(amtUsed,'unsignedInt') "set amtUsed";
  } "Add CLM_MDCR_HOSPC_PRD_CNT";
  institutionalComponents.CLM_MDCR_HHA_TOT_VISIT_CNT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_HHA_TOT_VISIT_CNT") "Add codeable concept";
    amtUsed -> tgtBBElement.value = cast(amtUsed,'unsignedInt') "set amtUsed";
  } "Add CLM_MDCR_HHA_TOT_VISIT_CNT";
  institutionalComponents.CLM_MDCR_IP_PPS_DRG_WT_NUM as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_DRG_WT_NUM") "Add codeable concept";
    amtUsed -> tgtBBElement.value = cast(amtUsed,'decimal') "set PPS DRG WT number";
  } "add PPS DRG WT ";
  institutionalComponents.CLM_INSTNL_CVRD_DAY_CNT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_INSTNL_CVRD_DAY_CNT") "Add codeable concept";
    amtUsed -> tgtBBElement.value = cast(amtUsed,'unsignedInt') "set amtUsed";
  } "Add CLM_INSTNL_CVRD_DAY_CNT";
  institutionalComponents.CLM_INSTNL_PER_DIEM_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_INSTNL_PER_DIEM_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_INSTNL_PER_DIEM_AMT";
  institutionalComponents.CLM_MDCR_IP_PPS_DSPRPRTNT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_DSPRPRTNT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_PPS_DSPRPRTNT_AMT";
  institutionalComponents.CLM_MDCR_IP_PPS_EXCPTN_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_EXCPTN_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_PPS_EXCPTN_AMT";
  institutionalComponents.CLM_MDCR_IP_PPS_CPTL_FSP_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_CPTL_FSP_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_PPS_CPTL_FSP_AMT";
  institutionalComponents.CLM_MDCR_IP_PPS_CPTL_IME_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_CPTL_IME_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_PPS_CPTL_IME_AMT";
  institutionalComponents.CLM_MDCR_IP_PPS_OUTLIER_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_OUTLIER_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_PPS_OUTLIER_AMT";
  institutionalComponents.CLM_MDCR_IP_PPS_CPTL_HRMLS_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_CPTL_HRMLS_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_PPS_CPTL_HRMLS_AMT";
  institutionalComponents.CLM_MDCR_IP_PPS_CPTL_TOT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_PPS_CPTL_TOT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_PPS_CPTL_TOT_AMT";
  institutionalComponents.CLM_MDCR_INSTNL_PRMRY_PYR_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_INSTNL_PRMRY_PYR_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_INSTNL_PRMRY_PYR_AMT";
  institutionalComponents.CLM_INSTNL_PRFNL_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_INSTNL_PRFNL_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_INSTNL_PRFNL_AMT";
  institutionalComponents.CLM_INSTNL_DRG_OUTLIER_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_INSTNL_DRG_OUTLIER_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_INSTNL_DRG_OUTLIER_AMT";
  institutionalComponents.CLM_HIPPS_UNCOMPD_CARE_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_HIPPS_UNCOMPD_CARE_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_HIPPS_UNCOMPD_CARE_AMT";
  institutionalComponents.CLM_FINL_STDZD_PYMT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_FINL_STDZD_PYMT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_FINL_STDZD_PYMT_AMT";
  institutionalComponents.CLM_HAC_RDCTN_PYMT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_HAC_RDCTN_PYMT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_HAC_RDCTN_PYMT_AMT";

  institutionalComponents.CLM_HIPPS_MODEL_BNDLD_PMT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_HIPPS_MODEL_BNDLD_PMT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_HIPPS_MODEL_BNDLD_PMT_AMT";
  institutionalComponents.CLM_HIPPS_READMSN_RDCTN_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_HIPPS_READMSN_RDCTN_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_HIPPS_READMSN_RDCTN_AMT";
  institutionalComponents.CLM_HIPPS_VBP_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_HIPPS_VBP_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_HIPPS_VBP_AMT";
  institutionalComponents.CLM_INSTNL_LOW_VOL_PMT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_INSTNL_LOW_VOL_PMT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_INSTNL_LOW_VOL_PMT_AMT";
  institutionalComponents.CLM_MDCR_IP_1ST_YR_RATE_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_1ST_YR_RATE_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_1ST_YR_RATE_AMT";
  institutionalComponents.CLM_MDCR_IP_SCND_YR_RATE_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_SCND_YR_RATE_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_SCND_YR_RATE_AMT";
  institutionalComponents.CLM_PPS_MD_WVR_STDZD_VAL_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_PPS_MD_WVR_STDZD_VAL_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_PPS_MD_WVR_STDZD_VAL_AMT";
  institutionalComponents.CLM_SITE_NTRL_CST_BSD_PYMT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_SITE_NTRL_CST_BSD_PYMT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_SITE_NTRL_CST_BSD_PYMT_AMT";
  institutionalComponents.CLM_SITE_NTRL_IP_PPS_PYMT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_SITE_NTRL_IP_PPS_PYMT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_SITE_NTRL_IP_PPS_PYMT_AMT";
  institutionalComponents.CLM_SS_OUTLIER_STD_PYMT_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_SS_OUTLIER_STD_PYMT_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_SS_OUTLIER_STD_PYMT_AMT";
  institutionalComponents.CLM_MDCR_IP_BENE_DDCTBL_AMT as amtUsed -> tgt.adjudication = create('BackboneElement') as tgtBBElement then {
    src -> tgtBBElement.category = cc("https://bluebutton.cms.gov/fhir/CodeSystem/Adjudication","CLM_MDCR_IP_BENE_DDCTBL_AMT") "Add codeable concept";
    src -> tgtBBElement.amount = create('Money') as tgtMoney then addMoney(amtUsed, tgtMoney) "Add Money";
  } "Add CLM_MDCR_IP_BENE_DDCTBL_AMT";
  } "Add wrapper for institutional components";
}

group addDiagnoses(source src: DiagnosisComponent, target tgt: BackboneElement){
  src.ROW_NUM as rowNum -> tgt.sequence = rowNum "set sequence number";
  src -> tgt.type = create('CodeableConcept') as tgtCC then{
    src.clm_prod_type_cd_map as typeCode where (typeCode = "A" or typeCode = "P") -> tgtCC.coding = translate(typeCode,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#HL7_DIAGTYPE','coding') "Add coding";
    src.clm_prod_type_cd_map as typeCode where (typeCode = "1" or typeCode = "D" or typeCode = "E" or typeCode = "R") -> tgtCC.coding = translate(typeCode,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#C4BB_DIAGTYPE','coding') "set coding";
  } "Add types";
  src.CLM_POA_IND as poaInd where (poaInd != ' ' and poaInd != '~' ) -> tgt.onAdmission = create('CodeableConcept') as tgtPOA,
    tgtPOA.coding = create('Coding') as tgtCoding,
    tgtCoding.system = "https://www.cms.gov/Medicare/Medicare-Fee-for-Service-Payment/HospitalAcqCond/Coding",
    tgtCoding.code = poaInd "Set POA indicator";
  src -> tgt.diagnosis = create('CodeableConcept') as tgtDiagnosis then {
    src -> tgtDiagnosis.coding = create('Coding') as tgtCoding then {
      //From CLM_PROD
      src.CLM_DGNS_PRCDR_ICD_IND as indicator -> tgtCoding.system = translate(indicator,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#CLM_DGNS_PRCDR_ICD_IND_DIAGNOSIS','code') "set system";
      src.CLM_DGNS_CD as diagnosisCode -> tgtCoding.code = diagnosisCode "set diagnosis code";
    } "set coding";
  } "Set diagnosis, including code";
}
//This is necessary due to clm_type_cd not being present in DiagnosisComponent (and C4BB_DIAGTYPE_PROF != C4BB_DIAGTYPE)
group addDiagnosesProfessional(source src: DiagnosisComponent, target tgt: BackboneElement){
  src.ROW_NUM as rowNum -> tgt.sequence = rowNum "set sequence number";
  src -> tgt.type = create('CodeableConcept') as tgtCC then{
    src.clm_prod_type_cd_map as typeCode where (typeCode = "A" or typeCode = "P") -> tgtCC.coding = translate(typeCode,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#HL7_DIAGTYPE','coding') "Add coding";
    src.clm_prod_type_cd_map as typeCode where (typeCode = "1" or typeCode = "D" or typeCode = "E" or typeCode = "R") -> tgtCC.coding = translate(typeCode,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#C4BB_DIAGTYPE_PROF','coding') "set coding";
  } "Add types";
  src -> tgt.diagnosis = create('CodeableConcept') as tgtDiagnosis then {
    src -> tgtDiagnosis.coding = create('Coding') as tgtCoding then {
      //From CLM_PROD
      src.CLM_DGNS_PRCDR_ICD_IND as indicator -> tgtCoding.system = translate(indicator,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#CLM_DGNS_PRCDR_ICD_IND_DIAGNOSIS','code') "set system";
      src.CLM_DGNS_CD as diagnosisCode -> tgtCoding.code = diagnosisCode "set diagnosis code";
    } "set coding";
  } "Set diagnosis, including code";
}

group addProcedures(source src: ProcedureComponent, target tgt: BackboneElement){
  src.CLM_VAL_SQNC_NUM as sequenceNum -> tgt.sequence = sequenceNum "set sequence number";
  src.CLM_VAL_SQNC_NUM as sequenceNum where sequenceNum = 1 -> tgt.type = cc("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBClaimProcedureType","principal") "Set type for principal";
  src.CLM_VAL_SQNC_NUM as sequenceNum where sequenceNum != 1 -> tgt.type = cc("http://hl7.org/fhir/us/carin-bb/CodeSystem/C4BBClaimProcedureType","other") "Set type for non-principal";
  src.CLM_PRCDR_PRFRM_DT as procedureDate where procedureDate > '2000-01-01'-> tgt.date = procedureDate "set procedure date";

  src -> tgt.procedure = create('CodeableConcept') as tgtProcedure then {
    src -> tgtProcedure.coding = create('Coding') as tgtCoding then {
      src.CLM_DGNS_PRCDR_ICD_IND as indicator -> tgtCoding.system = translate(indicator,'https://bfd.cms.gov/MappingLanguage/Maps/ExplanationOfBenefit-Helper#CLM_DGNS_PRCDR_ICD_IND_PROCEDURE','code') "set system";
      src.CLM_PRCDR_CD as procedureCode -> tgtCoding.code = procedureCode "set procedure code";
    } "set coding";
  } "Set procedure, including code";

}

group createInsurerOrgPartAB(source src: ExplanationOfBenefitBase, target tgtOrg: Organization){
  src -> tgtOrg.id = "insurer-org" "Set org id";
  src -> tgtOrg.meta = create('Meta') as tgtMeta then {
    src -> tgtMeta.profile = "http://hl7.org/fhir/us/carin-bb/StructureDefinition/C4BB-Organization|2.1.0" "Set org profile";
    src -> tgtMeta.profile = "http://hl7.org/fhir/us/core/StructureDefinition/us-core-organization|6.1.0" "Set org profile";
  } "Set organization metadata";
  src -> tgtOrg.active = "true" "set org status";
  src -> tgtOrg.name = "Centers for Medicare & Medicaid Services" "set org name";
}

group createOrg(source src: Provider, target tgt: Organization){
  src.PRVDR_SK as npi -> tgt.id = npi "Set org id";
  src -> tgt.meta = create('Meta') as tgtMeta then {
          src -> tgtMeta.profile = "http://hl7.org/fhir/us/carin-bb/StructureDefinition/C4BB-Organization|2.1.0" "Set org profile";
          src -> tgtMeta.profile = "http://hl7.org/fhir/us/core/StructureDefinition/us-core-organization|6.1.0" "Set org profile";
        } "Set practitioner metadata";
  src -> tgt.active = "true" "set org status";
  src.PRVDR_SK as npi -> tgt.identifier = create('Identifier') as tgtId then {
    src -> tgtId.type = cc("http://terminology.hl7.org/CodeSystem/v2-0203","NPI") "Add ID Type";
    src -> tgtId.system = "http://hl7.org/fhir/sid/us-npi" "set NPI system url";
    npi -> tgtId.value = npi "set NPI";
  } "Create NPI identifier";

  src.PRVDR_LGL_SLASH_LAST_NAME as orgName -> tgt.name = orgName;
  src.PRVDR_OSCAR_NUM as ccn -> tgt.identifier = create('Identifier') as tgtId then{
    src -> tgtId.system = "http://terminology.hl7.org/NamingSystem/CCN" "set ccn system url";
    src -> tgtId.value = ccn "set ccn";
  } "Add OSCAR/CCN num";

  src.PRVDR_TAX_NUM as taxId -> tgt.identifier = create('Identifier') as tgtId then{
    src -> tgtId.type = cc("http://terminology.hl7.org/CodeSystem/v2-0203","TAX") "set type";
    src -> tgtId.system = "urn:oid:2.16.840.1.113883.4.4" "add system";
    taxId -> tgtId.value = taxId "set tax Id";
  } "Add tax Id";

  src.CLM_BLG_PRVDR_ZIP5_CD as zip5 -> tgt.address = create('Address') as tgtAddress then{
    zip5-> tgtAddress.postalCode = zip5 "add zip code";
  } "Add zip code";
}

group createPractitioner(source src: Provider, target tgt: Practitioner){
  src.PRVDR_SK as npi -> tgt.id = npi "Set id";
  src -> tgt.meta = create('Meta') as tgtMeta then {
          src -> tgtMeta.profile = "http://hl7.org/fhir/us/carin-bb/StructureDefinition/C4BB-Practitioner|2.1.0" "Set profile";
          src -> tgtMeta.profile = "http://hl7.org/fhir/us/core/StructureDefinition/us-core-practitioner|6.1.0" "Set profile";
  } "Set practitioner metadata";

  src -> tgt.identifier = create('Identifier') as tgtId then {
    src -> tgtId.type = cc("http://terminology.hl7.org/CodeSystem/v2-0203","NPI") "Add ID Type";
    src -> tgtId.system = "http://hl7.org/fhir/sid/us-npi" "set NPI system url";
    src.PRVDR_SK as npi -> tgtId.value = npi "set NPI";
  } "Create NPI identifier";

  src.PRVDR_OSCAR_NUM as ccn -> tgt.identifier = create('Identifier') as tgtId then{
    src -> tgtId.system = "http://terminology.hl7.org/NamingSystem/CCN" "set ccn system url";
    src -> tgtId.value = ccn "set ccn";
  } "Add OSCAR/CCN num";

  src.PRVDR_TAX_NUM as taxId -> tgt.identifier = create('Identifier') as tgtId then{
    src -> tgtId.type = cc("http://terminology.hl7.org/CodeSystem/v2-0203","TAX") "set type";
    src -> tgtId.system = "urn:oid:2.16.840.1.113883.4.4" "add system";
    taxId -> tgtId.value = taxId "set tax Id";
  } "Add tax Id";

  src.PRVDR_LGL_SLASH_LAST_NAME as familyName -> tgt.name = create('HumanName') as tgtName then {
    familyName -> tgtName.family = familyName "set family name";
    src.PRVDR_1ST_NAME as firstName -> tgtName.given = firstName "set first name";
  } "Add name";

  src.CLM_BLG_PRVDR_ZIP5_CD as zip5 -> tgt.address = create('Address') as tgtAddress then{
    zip5-> tgtAddress.postalCode = zip5 "add zip code";
  } "Add zip code";
}


