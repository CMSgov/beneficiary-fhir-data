package gov.cms.bfd.server.ng.claim.model;

import gov.cms.bfd.server.ng.SystemUrls;
import java.util.Arrays;
import java.util.Optional;
import lombok.AllArgsConstructor;
import lombok.Getter;
import org.hl7.fhir.r4.model.CodeableConcept;
import org.hl7.fhir.r4.model.Coding;
import org.hl7.fhir.r4.model.ExplanationOfBenefit;
import org.hl7.fhir.r4.model.Organization;
import org.hl7.fhir.r4.model.Reference;

@Getter
@AllArgsConstructor
public enum ClaimTypeCode {
  _1(1, "MEDICARE PART D ORIGINAL CLAIM"),
  _2(2, "MEDICARE PART D ADJUSTED CLAIM"),
  _3(3, "MEDICARE PART D DELETED CLAIM"),
  _4(4, "MEDICARE PART D RESUBMITTED CLAIM"),
  _10(10, "MEDICARE HHA CLAIM"),
  _20(20, "MEDICARE NON-SWING BED SNF CLAIM"),
  _30(30, "MEDICARE SWING BED SNF CLAIM"),
  _40(40, "MEDICARE OUTPATIENT CLAIM"),
  _50(50, "MEDICARE HOSPICE CLAIM"),
  _60(60, "MEDICARE INPATIENT CLAIM"),
  _61(61, "MEDICARE INPATIENT FULL ENCOUNTER CLAIM"),
  _62(62, "MEDICARE ADVANTAGE IME/GME CLAIMS"),
  _63(63, "MEDICARE ADVANTAGE (NO-PAY) CLAIMS"),
  _64(64, "MEDICARE ADVANTAGE (PAID AS FFS) CLAIMS"),
  _71(71, "MEDICARE PART B PROFESSIONAL PHYSICIAN/SUPPLIER CLAIM (NON-DMEPOS)"),
  _72(72, "MEDICARE PART B PROFESSIONAL PHYSICIAN/SUPPLIER CLAIM (DMEPOS)"),
  _81(81, "MEDICARE PART B DME REGIONAL CARRIER (DMERC) CLAIM (NON-DMEPOS)"),
  _82(82, "MEDICARE PART B DME REGIONAL CARRIER (DMERC) CLAIM (DMEPOS)"),
  _1000(1000, "000X MEDICARE SS OTHER TYPE OF BILL GROUPS - PHASE 1"),
  _1011(1011, "011X MEDICARE SS HOSPITAL INPATIENT (PART A) - PHASE 1"),
  _1012(1012, "012X MEDICARE SS HOSPITAL INPATIENT (PART B) - PHASE 1"),
  _1013(1013, "013X MEDICARE SS HOSPITAL OUTPATIENT - PHASE 1"),
  _1014(1014, "014X MEDICARE SS HOSPITAL OTHER (PART B) - PHASE 1"),
  _1018(1018, "018X MEDICARE SS HOSPITAL SWING BED - PHASE 1"),
  _1019(1019, "019X MEDICARE SS - HOSPITAL RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1021(1021, "021X MEDICARE SS SNF INPATIENT (PART A)- PHASE 1"),
  _1022(1022, "022X MEDICARE SS SNF INPATIENT (PART B) - PHASE 1"),
  _1023(1023, "023X MEDICARE SS SNF OUTPATIENT - PHASE 1"),
  _1028(1028, "028X MEDICARE SS SNF SWING BED - PHASE 1"),
  _1029(1029, "029X MEDICARE SS - SKILLED NURSING RESERVED FOR NATIONAL ASSIGNMENT- PHASE 1"),
  _1032(1032, "032X MEDICARE SS HOME HEALTH INPATIENT (PART B) - PHASE 1"),
  _1033(1033, "033X MEDICARE SS HOME HEALTH OUTPATIENT - PHASE 1"),
  _1034(1034, "034X MEDICARE SS HOME HEALTH (PART B ONLY) - PHASE 1"),
  _1039(1039, "039X MEDICARE SS HHA - RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1041(1041, "041X MEDICARE SS RELIGIOUS NONMEDICAL HEALTH CARE INSTITUTIONS - PHASE 1"),
  _1042(
      1042,
      "042X MEDICARE SS RNHCI HOSPITAL-INPATIENT OR HOME HEALTH VISITS (PART B ONLY) - PHASE 1"),
  _1043(1043, "043X MEDICARE SS RNHCI HOSPITAL-OUTPATIENT (HHA-A ALSO) - PHASE 1"),
  _1049(1049, "049X MEDICARE SS RNHCI HOSPITAL-RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1065(1065, "065X MEDICARE SS INTERMEDIATE CARE - LEVEL I PHASE 1"),
  _1066(1066, "066X MEDICARE SS INTERMEDIATE CARE LEVEL II PHASE 1"),
  _1069(1069, "069X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1071(1071, "071X MEDICARE SS CLINIC RHC RURAL HEALTH - PHASE 1"),
  _1072(1072, "072X MEDICARE SS CLINIC ESRD RENAL DIALYSIS - PHASE 1"),
  _1073(1073, "073X MEDICARE SS CLINIC FREESTANDING - PHASE 1"),
  _1074(1074, "074X MEDICARE SS CLINIC ORF OTHER REHAB - PHASE 1"),
  _1075(1075, "075X MEDICARE SS CLINIC CORF COMPREHENSIVE OUTPATIENT REHAB - PHASE 1"),
  _1076(1076, "076X MEDICARE SS CLINIC CMHC COMMUNITY MENTAL HEALTH CENTERS - PHASE 1"),
  _1077(1077, "077X MEDICARE SS CLINIC FQHC FEDERAL QUALIFIED HEALTH CENTER - PHASE 1"),
  _1078(
      1078,
      "078X MEDICARE SS LICENSED FREESTANDING EMERGENCY MEDICAL FACILITY (EFFECTIVE 7/1/12) - PHASE 1"),
  _1079(1079, "079X MEDICARE SS CLINIC - OTHER - PHASE 1"),
  _1081(1081, "081X MEDICARE SS HOSPICE NONHOSPITAL-BASED - PHASE 1"),
  _1082(1082, "082X MEDICARE SS HOSPICE HOSPITAL-BASED - PHASE 1"),
  _1083(1083, "083X MEDICARE SS ASC AMBULATORY SURGERY CENTER - PHASE 1"),
  _1084(1084, "084X MEDICARE SS SPECIAL FACILITY FREESTANDING BIRTHING CENTER - PHASE 1"),
  _1085(1085, "085X MEDICARE SS CAH CRITICAL ACCESS HOSPITAL - PHASE 1"),
  _1086(1086, "086X MEDICARE SS SPECIAL FACILITY RESIDENTIAL FACILITY _ PHASE 1"),
  _1087(
      1087,
      "087X MEDICARE SS FREESTANDING NON-RESIDENTIAL OPIOID TREATMENT PROGRAM (EFFECTIVE 1/1/21) - PHASE 1"),
  _1088(1088, "088X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1089(1089, "089X MEDICARE SS SPECIAL FACILITY OR ASC SURGERY-OTHER  PHASE 1"),
  _1091(1091, "091X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1092(1092, "092X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1093(1093, "093X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1094(1094, "094X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1095(1095, "095X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1096(1096, "096X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1097(1097, "097X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1098(1098, "098X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1099(1099, "099X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT - PHASE 1"),
  _1700(1700, "PROF MEDICARE SS PART B PROFESSIONAL - PHASE 1"),
  _1800(1800, "DME MEDICARE SS DME - PHASE 1"),
  _1900(1900, "HOSPICE NOTICE OF ELECTION - PHASE 1"),
  _2000(2000, "000X MEDICARE SS OTHER TYPE OF BILL GROUPS"),
  _2011(2011, "011X MEDICARE SS HOSPITAL INPATIENT (PART A)"),
  _2012(2012, "012X MEDICARE SS HOSPITAL INPATIENT (PART B)"),
  _2013(2013, "013X MEDICARE SS HOSPITAL OUTPATIENT"),
  _2014(2014, "014X MEDICARE SS HOSPITAL OTHER (PART B)"),
  _2018(2018, "018X MEDICARE SS HOSPITAL SWING BED"),
  _2019(2019, "019X MEDICARE SS - HOSPITAL RESERVED FOR NATIONAL ASSIGNMENT"),
  _2021(2021, "021X MEDICARE SS SNF INPATIENT"),
  _2022(2022, "022X MEDICARE SS SNF INPATIENT"),
  _2023(2023, "023X MEDICARE SS SNF OUTPATIENT"),
  _2028(2028, "028X MEDICARE SS SNF SWING BED"),
  _2029(2029, "029X MEDICARE SS - SKILLED NURSING RESERVED FOR NATIONAL ASSIGNMENT"),
  _2032(2032, "032X MEDICARE SS HOME HEALTH INPATIENT (PART B)"),
  _2033(2033, "033X MEDICARE SS HOME HEALTH OUTPATIENT"),
  _2034(2034, "034X MEDICARE SS HOME HEALTH (PART B ONLY)"),
  _2039(2039, "039X MEDICARE SS HHA - RESERVED FOR NATIONAL ASSIGNMENT"),
  _2041(2041, "041X MEDICARE SS RELIGIOUS NONMEDICAL HEALTH CARE INSTITUTIONS"),
  _2042(2042, "042X MEDICARE SS RNHCI HOSPITAL-INPATIENT OR HOME HEALTH VISITS (PART B ONLY)"),
  _2043(2043, "043X MEDICARE SS RNHCI HOSPITAL-OUTPATIENT (HHA-A ALSO)"),
  _2049(2049, "049X MEDICARE SS RNHCI HOSPITAL-RESERVED FOR NATIONAL ASSIGNMENT "),
  _2065(2065, "065X MEDICARE SS INTERMEDIATE CARE - LEVEL I"),
  _2066(2066, "066X MEDICARE SS INTERMEDIATE CARE LEVEL II"),
  _2069(2069, "069X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2071(2071, "071X MEDICARE SS CLINIC RHC RURAL HEALTH"),
  _2072(2072, "072X MEDICARE SS CLINIC ESRD RENAL DIALYSIS"),
  _2073(2073, "073X MEDICARE SS CLINIC FREESTANDING"),
  _2074(2074, "074X MEDICARE SS CLINIC ORF OTHER REHAB"),
  _2075(2075, "075X MEDICARE SS CLINIC CORF COMPREHENSIVE OUTPATIENT REHAB"),
  _2076(2076, "076X MEDICARE SS CLINIC CMHC COMMUNITY MENTAL HEALTH CENTERS"),
  _2077(2077, "077X MEDICARE SS CLINIC FQHC FEDERAL QUALIFIED HEALTH CENTER"),
  _2078(
      2078, "078X MEDICARE SS LICENSED FREESTANDING EMERGENCY MEDICAL FACILITY (EFFECTIVE 7/1/12)"),
  _2079(2079, "079X MEDICARE SS CLINIC - OTHER"),
  _2081(2081, "081X MEDICARE SS HOSPICE NONHOSPITAL-BASED"),
  _2082(2082, "082X MEDICARE SS HOSPICE HOSPITAL-BASED"),
  _2083(2083, "083X MEDICARE SS ASC AMBULATORY SURGERY CENTER"),
  _2084(2084, "084X MEDICARE SS SPECIAL FACILITY FREESTANDING BIRTHING CENTER"),
  _2085(2085, "085X MEDICARE SS CAH CRITICAL ACCESS HOSPITAL"),
  _2086(2086, "086X MEDICARE SS SPECIAL FACILITY RESIDENTIAL FACILITY"),
  _2087(
      2087,
      "087X MEDICARE SS FREESTANDING NON-RESIDENTIAL OPIOID TREATMENT PROGRAM (EFFECTIVE 1/1/21)"),
  _2088(2088, "088X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2089(2089, "089X MEDICARE SS SPECIAL FACILITY OR ASC SURGERY-OTHER"),
  _2091(2091, "091X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2092(2092, "092X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2093(2093, "093X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2094(2094, "094X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2095(2095, "095X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2096(2096, "096X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2097(2097, "097X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2098(2098, "098X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2099(2099, "099X MEDICARE SS RESERVED FOR NATIONAL ASSIGNMENT"),
  _2700(2700, "PROF MEDICARE SS PART B PROFESSIONAL"),
  _2800(2800, "DME MEDICARE SS DME"),
  _2900(2900, "HOSPICE NOTICE OF ELECTION");

  private final int code;
  private final String display;
  private static final String INSURER_ORG = "insurer-org";

  public static ClaimTypeCode fromCode(int code) {
    return Arrays.stream(values()).filter(c -> c.code == code).findFirst().get();
  }

  CodeableConcept toFhirType() {
    var codeableConcept =
        new CodeableConcept(
            new Coding()
                .setSystem(SystemUrls.BLUE_BUTTON_CLAIM_TYPE_CODE)
                .setCode(String.valueOf(code))
                .setDisplay(display));
    getClaimType().ifPresent(t -> codeableConcept.addCoding(t.toFhir()));
    return codeableConcept;
  }

  Optional<CodeableConcept> toFhirSubtype() {
    return getClaimSubtype().map(subtype -> new CodeableConcept(subtype.toFhir()));
  }

  Optional<Organization> toFhirInsurerPartAB() {
    if (!isBetween(5, 3999)) {
      return Optional.empty();
    }

    var organization = OrganizationFactory.toFhir();
    organization.setId(INSURER_ORG);
    organization.setName("Centers for Medicare and Medicaid Services");
    return Optional.of(organization);
  }

  Optional<ExplanationOfBenefit.InsuranceComponent> toFhirInsurance() {
    var shouldAdd =
        switch (code) {
          case 60, 61, 62, 63, 64, 1011, 1041, 2011, 2041 -> true;
          default -> false;
        };
    if (!shouldAdd) {
      return Optional.empty();
    }

    return Optional.of(
        new ExplanationOfBenefit.InsuranceComponent()
            .setFocal(true)
            .setCoverage(new Reference().setDisplay("Part A")));
  }

  boolean isBetween(int lower, int upper) {
    return (code >= lower) && (code <= upper);
  }

  Optional<String> toFhirStructureDefinition() {
    return switch (code) {
      case 1, 2, 3, 4 -> Optional.of(SystemUrls.CARIN_STRUCTURE_DEFINITION_PHARMACY);
      case 10, 20, 30, 50, 60, 61, 62, 63, 1011, 2011 ->
          Optional.of(SystemUrls.CARIN_STRUCTURE_DEFINITION_INPATIENT_INSTITUTIONAL);
      case 40 -> Optional.of(SystemUrls.CARIN_STRUCTURE_DEFINITION_OUTPATIENT_INSTITUTIONAL);
      case 71, 72, 81, 82 -> Optional.of(SystemUrls.CARIN_STRUCTURE_DEFINITION_PROFESSIONAL);
      default -> Optional.empty();
    };
  }

  private Optional<ClaimSubtype> getClaimSubtype() {
    return switch (code) {
      case 10, 20, 30, 50, 60, 61, 62, 63, 1011, 1041, 2011, 2041 ->
          Optional.of(ClaimSubtype.INPATIENT);
      case 40 -> Optional.of(ClaimSubtype.OUTPATIENT);
      default -> Optional.empty();
    };
  }

  private Optional<ClaimType> getClaimType() {
    return switch (code) {
      case 1, 2, 3, 4 -> Optional.of(ClaimType.PHARMACY);
      case 10, 20, 30, 40, 50, 60, 61, 62, 63, 1011, 2011 -> Optional.of(ClaimType.INSTITUTIONAL);
      case 71, 72, 81, 82 -> Optional.of(ClaimType.PROFESSIONAL);
      default -> Optional.empty();
    };
  }
}
