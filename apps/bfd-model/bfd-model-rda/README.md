# RDA API Database Entities

This project builds a JAR file containing the JPA entity classes used to store data collected from the
Replicated Data Access (RDA) API.

The associated migration scripts to manage the database schema used by these entities are maintained in
the `bfd-model-rif` project.

## persistence.xml

Hibernate will only auto-discover entity objects located in the same JAR as the `persistence.xml` file.
The normal `persistence.xml` file for the ETL pipeline is located in the `bfd-model-rif` project
This is not a problem for the ETL process since it is deployed inside of an 'uber-jar' containing classes
from all of the maven projects that it depends on.  Nor is it a problem for the BFD server since it
uses Spring to build up its JPA configuration and Spring does not have the same limitation.

However for unit and integration tests within each project we need a different `persistence.xml` file
to allow the RDA entities to be used with JPA.  The `persistence.xml` file in this project defines a
persistence unit named `gov.cms.bfd.rda` that contains only the RDA entity classes.

## Entity Code Generation

Most database entities are generated by the DSL plugin using mapping files stored in the `mappings` subdirectory.
Some utility entities are hand-written as Java classes.  The code generation is triggered by 
a `plugin` element in this project's `pom.xml` file.

## MBI Caching

Both FISS and MCS claims use MBI to identify beneficiaries.  Since computing hashed MBI values
is slow and many claims share the same MBI this RDA schema is normalized to use a
single table, `mbi_cache` to hold all MBI values and hashes.  The claims tables have a foreign
key column `mbi_id` to reference the appropriate MBI record.

```
                        ┌─────────────┐
                        │ mbi_cache   │
                   ┌────► - mbi_id    ◄───┐
                   │    │ - hash      │   │
                   │    │ - old_hash  │   │
                   │    └─────────────┘   │
┌─────────────┐    │                      │    ┌────────────┐
│ fiss_claims │    │                      │    │ mcs_claims │
│ - mbi_id    ├────┘                      └────┤ - mbi_id   │
└─────────────┘                                └────────────┘
```

## FISS Claims

Each FISS claim is stored in a record of the `fiss_claims` table.
Each record in the table contains the information from an RDA API `FissClaim` message.

Several tables reference the claim and add additional detail records received in
array fields within the `FissClaim` message.  
The names of all detail tables begin with `fiss_` to indicate which type of claim they 
relate to.  
Each detail table has a column named `dcn` that identifies the claim and a `priority` column
containing the array index of that detail record when it was received from the RDA API.

| Table Name           | RDA API Array Field | RDA API Message Class | Proto File                |
|----------------------|---------------------|-----------------------|---------------------------|
| fiss_audit_trails    | fiss_audit_trail    | FissAuditTrail        | fiss_audit_trail.proto    |
| fiss_diagnosis_codes | fiss_diag_codes     | FissDiagnosisCode     | fiss_diagnosis_code.proto |
| fiss_payers          | fiss_payers         | FissPayer             | fiss_payer.proto          |
| fiss_proc_codes      | fiss_proc_codes     | FissProcedureCode     | fiss_procedure_code.proto |
| fiss_revenue_lines   | fiss_revenue_lines  | FissRevenueLine       | fiss_revenue_line.proto   |


This diagram shows all of the FISS related tables along with their primary keys.

```
                                    ┌─────────────┐
                                    │ fiss_claims │
                         ┌──────────► - claim_id  │
                         │          └─────────────┘
                claim_id │
                         │
                         │
          ┌──────────────┴───────┬────────────────────┬────────────────--┐───────--------------┐
          │                      │                    │                  │                     │
┌─────────┴─────────┐ ┌──────────┴───────────┐ ┌──────┴──────--┐ ┌───────┴─────────┐ ┌───────--┴────────--┐
│ fiss_audit_trails │ │ fiss_diagnosis_codes │ │fiss_payers    │ │ fiss_proc_codes │ │ fiss_revenue_lines │
│ - claim_id        │ │ - claim_id           │ │- claim_id     │ │ - claim_id      │ │ - claim_id         │
│ - rda_position    │ │ - rda_position       │ │- rda_position │ │ - rda_position  │ │ - rda_position     │
└───────────────────┘ └──────────────────────┘ └─────────────--┘ └─────────────────┘ └───────────────---──┘
```

## MCS Claims

Each MCS claim is stored in a record of the `mcs_claims` table.  
Each record in the table contains the information from an RDA API `McsClaim` message.

Several tables reference the claim and add additional detail records received in
array fields within the `McsClaim` message.
The names of all detail tables begin with `mcs_` to indicate which type of claim they 
relate to.  
Each detail table has a column named `idr_clm_hd_icn` that identifies the claim and a `priority`
column containing the array index of that detail record when it was received from the RDA API.

| Table Name          | RDA API Array Field | RDA API Message Class | Proto File               |
|---------------------|---------------------|-----------------------|--------------------------|
| mcs_adjustments     | mcs_adjustments     | McsAdjustment         | mcs_adjustment.proto     |
| mcs_audits          | mcs_audits          | McsAudit              | mcs_audit.proto          |
| mcs_details         | mcs_details         | McsDetail             | mcs_detail.proto         |
| mcs_diagnosis_codes | mcs_diagnosis_codes | McsDiagnosisCode      | mcs_diagnosis_code.proto |
| mcs_locations       | mcs_locations       | McsLocation           | mcs_location.proto       |

This diagram shows all of the MCS related tables along with their primary keys.

```
                               ┌─────────────────────┐
                               │ mcs_adjustments     │
                          ┌────┤ - idr_clm_hd_icn    │
                          │    │ - rda_position      │
                          │    └─────────────────────┘
                          │
                          │    ┌─────────────────────┐
                          │    │ mcs_audits          │
                          ├────┤ - idr_clm_hd_icn    │
                          │    │ - rda_position      │
                          │    └─────────────────────┘
                          │
┌──────────────────┐      │    ┌─────────────────────┐
│ mcs_claims       │      │    │ mcs_details         │
│ - idr_clm_hd_icn ◄──────┼────┤ - idr_clm_hd_icn    │
└──────────────────┘      │    │ - rda_position      │
                          │    └─────────────────────┘
                          │
                          │    ┌─────────────────────┐
                          │    │ mcs_diagnosis_codes │
                          ├────┤ - idr_clm_hd_icn    │
                          │    │ - rda_position      │
                          │    └─────────────────────┘
                          │
                          │    ┌─────────────────────┐
                          │    │ mcs_locations       │
                          └────┤ - idr_clm_hd_icn    │
                               │ - rda_position      │
                               └─────────────────────┘
```

## RDA API Progress

The RDA ETL pipeline jobs consume data by calling a gRPC service in the RDA API.  This service
returns a stream of claim messages.  Each message represents either a new claim or an update
to an existing claim.  Every message includes a sequence number.  These sequence numbers
can be used to track progress within the stream and to resume from a specific location
in the stream in a later RPC call.

The `rda_api_progress` table is used to store the last processed sequence number for each claim type.
The pipeline jobs update the table as they process incoming claims.  The jobs can be forced to
replay data by stopping the job, changing the `last_sequence_number` value for the appropriate
claim type, and restarting the pipeline job.

## Message Errors

The RDA ETL pipeline jobs transform incoming messages into claim entities.  This transformation
includes validation of the message contents.  If any of these validations fail the jobs insert a record
into the `message_errors` table including the nature of the error and details of the message that
triggered the error.

## Claim Meta Data

Each claim will be received multiple times from the RDA API and we only store the latest
version of each claim.  This can make analysis of how claim data changes over time impossible.
The `claim_message_meta_data` table solves this problem by storing a subset of fields from
each claim update for use in data analysis.

The table has a compound primary key:

- claim_type: Either F for FISS or M for MCS.
- sequence_number: The sequence number of the claim update.
- claim_id: claim_id value for FISS or idr_clm_hd_icn value for MCS
