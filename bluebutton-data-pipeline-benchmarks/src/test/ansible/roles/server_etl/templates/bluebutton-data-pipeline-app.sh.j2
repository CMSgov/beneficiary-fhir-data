#!/bin/bash

export S3_BUCKET_NAME='gov.hhs.cms.bluebutton.datapipeline.benchmark.iteration{{ iteration_index }}'
export HICN_HASH_ITERATIONS='2'  # The minimum number of iterations recommended by NIST is 1000.
export HICN_HASH_PEPPER='6E6F747468657265616C706570706572'  # Hex-encoded "nottherealpepper".
export DATABASE_URL='jdbc:postgresql://{{ hostvars['rds']['endpoint'] }}:{{ hostvars['rds']['port'] }}/fhirdb'
export DATABASE_USERNAME='{{ postgres_master_username }}'
export DATABASE_PASSWORD='{{ postgres_master_password }}'
export LOADER_THREADS={{ etl_loader_threads }}

{# The 'env' lookup plugin retries values from the management machine. #}
{# This test will fail if both variables aren't defined and non-empty. #}
{% if lookup('env','AWS_ACCESS_KEY_ID') and lookup('env','AWS_SECRET_ACCESS_KEY') %}
export AWS_ACCESS_KEY_ID='{{ lookup('env','AWS_ACCESS_KEY_ID') }}'
export AWS_SECRET_ACCESS_KEY='{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}'
{% endif %}

java \
	-Xmx40g \
	-jar "/usr/local/bluebutton-data-pipeline-app/bluebutton-data-pipeline-app-capsule-fat.jar" \
	&>> "/usr/local/bluebutton-data-pipeline-app/bluebutton-data-pipeline-app.log"
