---
###
# Installs the cloudwatch unified agent.
###

- name: cwagent | Copy agent configuration file
  template:
    src: 'templates/cwagent.json.j2'
    dest: "/tmp/cwagent-base.json"
    mode: u=rw,g=r,o=r
  become: true
  tags:
    - pre-ami

- name: cwagent | Copy OpenTelemetry agent configuration file
  template:
    src: 'templates/cwagent-opentel-base.yaml.j2'
    dest: "/opt/aws/amazon-cloudwatch-agent/cwagent-otel-collector/etc/cwagent-otel-collector.d/cwagent-opentel-base.yaml"
    mode: u=rw,g=r,o=r
  become: true
  tags:
    - pre-ami

- name: cwagent | start agent
  shell: "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/tmp/cwagent-base.json -s"
  become: true
  tags:
    - pre-ami

- name: Configure and launch CloudWatch unified agent OpenTelemetry process
  shell: "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -o file:/opt/aws/amazon-cloudwatch-agent/cwagent-otel-collector/etc/cwagent-otel-collector.d/cwagent-opentel-base.yaml -s"
  become: true
  tags:
    - pre-ami