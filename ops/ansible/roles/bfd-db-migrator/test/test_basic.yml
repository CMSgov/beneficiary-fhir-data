---
##
# Applies and verifies the role on the container being used for the test case.
##

# Apply the role.
- hosts: bfd-db-migrator
  tasks:
    - name: Apply Role
      import_role:
        name: bfd-db-migrator
      vars:
        db_migrator_zip: "{{ lookup('env','HOME') }}/.m2/repository/gov/cms/bfd/bfd-db-migrator/1.0.0-SNAPSHOT/bfd-db-migrator-1.0.0-SNAPSHOT.zip"
        db_migrator_db_url: 'jdbc:hsqldb:mem:test'
        db_migrator_db_username: "bfd"
        db_migrator_db_password: "bfd"

# Verify that things worked as expected.
- hosts: bfd-db-migrator
  tasks:
    - name: Ensure Service Is Running
      service:
        name: bfd-db-migrator
        state: started
        enabled: yes
      changed_when: false
      become: true

    - name: Grab Log Contents
      command: cat /opt/bfd-db-migrator/migrator-log.json
      changed_when: false
      register: read_log

    - name: Log Failed Application Launches
      debug:
        msg: "{{ read_log.stdout }}"
      when: "'Successfully started' not in read_log.stdout"

    - name: Verify Log Contents
      action: fail
      when: "'Successfully started' not in read_log.stdout"
