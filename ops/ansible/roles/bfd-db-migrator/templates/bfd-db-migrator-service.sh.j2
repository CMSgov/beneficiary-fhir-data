#!/usr/bin/env bash

export DATABASE_PASSWORD='{{ password }}'
export DATABASE_URL='{{ url }}'
export DATABASE_USERNAME='{{ username }}'

# The expression {{ '#' if foo|default('', true)|length < 1 }} prepends exports with '#' to prevent
# undefined or empty 'foo' variable from entering the environment. Maintains the existing templating
# strategy and remains flexible for manual manipulation of resultant script in development and
# troubleshooting scenarios.
# DATABASE_MAX_POOL_SIZE defaults to 1 in the bfd-db-migrator application
{{ '#' if max_connections |default('', true)|length < 1 }}export DATABASE_MAX_POOL_SIZE='{{ max_connections |default('', true) }}'

{{ '#' if not migrator_monitor_enabled|default(true) or not sqs_queue_name|default(false) else '' }}export DB_MIGRATOR_SQS_QUEUE='{{ queue_name }}'

{%- if license_key is defined %}
export NEW_RELIC_METRIC_KEY='{{ license_key }}'
{%- endif %}

{%- if host is defined %}
export NEW_RELIC_METRIC_HOST='{{ host }}'
{%- endif %}

{%- if path is defined %}
export NEW_RELIC_METRIC_PATH='{{ path }}'
{%- endif %}

{%- if period is defined %}
export NEW_RELIC_METRIC_PERIOD='{{ period }}'
{%- endif %}

LOGS_DIR='{{ logs }}'

exec "{{ db_migrator_dir }}/bfd-db-migrator-{{ bfd_version }}/bfd-db-migrator.sh" \
	"-DbfdDbMigrator.logs.dir=${LOGS_DIR}" \
	-Djava.io.tmpdir={{ tmp }} \
	&>> "{{ launcher_log }}"
