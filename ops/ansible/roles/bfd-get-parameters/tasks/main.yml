---
# tasks file for bfd-get-parameters
### This role has a few different ways of pulling configurations, secrets, key/value pairs, etc... from the AWS SSM Parameter Store.
### It is a proof of concept, not a final solution.
- hosts: all
### The block of name, hosts, and connection can be used for testing locally.
#- name: Run playbook locally
#  hosts: 127.0.0.1
#  connection: local
  vars:
    project: bbrooks
    stage: dev
    date: 20190905
    path: "/{{ project }}/{{ stage }}/{{ date }}/"
  tasks:
  - name: return a dictionary of ssm parameters from a hierarchy path with shortened names
    debug: msg="{{ lookup('aws_ssm', '{{ path }}', region="us-east-2", shortnames=true, bypath=true, recursive=true, decrypt=True ) }}"
    register: vars_output
### Need below to show each key/value pair
  - name: return registered parameters
    debug: msg="Output={{ item }}"
      var: vars_output

  - shell: "export {{ item.key }}={{ item.value }}"
    loop: "{{ lookup('aws_ssm', '/bbrooks/dev/20190905/', region='us-east-2', shortnames=true, bypath=true, recursive=true, decrypt=True )|dict2items }}"

  - name: Getting parameters from Parameter Store
    shell: $(aws ssm get-parameters-by-path --with-decryption  --path {{ path }} | jq -r '.Parameters| .[] | "export " + .Name + "=\"" + .Value + "\""  ' | sed "s|/{{ project }}/{{ stage }}/{{ date }}/||g")

#  - name: Registered Output
#    debug: 
#      var: vars_output