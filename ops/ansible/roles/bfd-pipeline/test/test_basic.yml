---
##
# Applies and verifies the role on the container being used for the test case.
##

- hosts: localhost
  tasks:
    - name: Download BFD Pipeline ZIP
      maven_artifact:
        repository_url: 'https://maven.pkg.github.com/CMSgov/beneficiary-fhir-data'
        group_id: 'gov.cms.bfd'
        artifact_id: 'bfd-pipeline-app'
        version: '1.0.0-SNAPSHOT'
        extension: 'zip'
        dest: /tmp/bfd-pipeline-app.zip

# Apply the role.
- hosts: docker_container
  tasks:
    - name: Install Prerequisites
      package:
        name:
          - unzip
        state: present
      become: true

    - name: Apply Role
      import_role:
        name: bfd-pipeline
      vars:
        data_pipeline_zip: /tmp/bfd-pipeline-app.zip
        data_pipeline_s3_bucket: 'example-fake'  # Doesn't need to actually exist.
        data_pipeline_hicn_hash_iterations: '42'  # NIST recommends at least 1000
        data_pipeline_hicn_hash_pepper: '6E6F747468657265616C706570706572'  # Hex-encoded "nottherealpepper".
        data_pipeline_db_url: 'jdbc:hsqldb:mem:test'
        data_pipeline_db_username: ""
        data_pipeline_db_password: ""

# Verify that things worked as expected.
- hosts: docker_container
  tasks:
    - name: Ensure Service Is Running
      service:
        name: bfd-pipeline
        state: started
        enabled: yes
      changed_when: false
      become: true

    - name: Grab Log Contents
      command: cat /usr/local/bfd-pipeline/bluebutton-data-pipeline.log
      changed_when: false
      register: command_cat_pipeline_log

    - name: Verify Log Contents
      action: fail
      when: "'Application starting up!' not in command_cat_pipeline_log.stdout"
