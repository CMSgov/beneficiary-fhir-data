---
##
# Applies and verifies the role on the container being used for the test case.
##

- hosts: bfd-pipeline
  tasks:
    - name: Apply Role
      import_role:
        name: bfd-pipeline
      vars:
        data_pipeline_zip: "{{ lookup('env','HOME') }}/.m2/repository/gov/cms/bfd/bfd-pipeline-app/1.0.0-SNAPSHOT/bfd-pipeline-app-1.0.0-SNAPSHOT.zip"
        data_pipeline_s3_bucket: 'example-fake'  # Doesn't need to actually exist.
        data_pipeline_hicn_hash_iterations: '42'  # NIST recommends at least 1000
        data_pipeline_hicn_hash_pepper: '6E6F747468657265616C706570706572'  # Hex-encoded "nottherealpepper".
        data_pipeline_db_url: jdbc:postgresql://db:5432/fhirdb
        data_pipeline_db_username: bfd
        data_pipeline_db_password: bfd
        data_pipeline_dir: /usr/local/bluebutton-data-pipeline

    - name: Ensure Service Is Running
      service:
        name: bfd-pipeline
        state: started
        enabled: yes
      changed_when: false
      become: true

    - name: Check bluebutton-data-pipeline.log
      shell: grep 'Application starting up!' {{ data_pipeline_dir }}/bluebutton-data-pipeline.log
      changed_when: false
      register: check_result
      until: "check_result is not failed"
      retries: 20
      delay: 5
