---
##
# Configures the BFD DB Migrator Service for CCS env
##
- name: Configure server-load Controller
  hosts: all
  become: true
  remote_user: ec2-user
  gather_facts: yes
  vars:
    ansible_ssh_pipelining: no
    server_load_dir: /opt/server-load
    # TODO: Consider removing `env` when SSH/sudoer users have been resolved in SSM BFD-2068
    env: "test"

  tasks:
    # TODO: Remove include_vars when SSH/sudoer users have been resolved in SSM BFD-2068
    - name: Include env specific variables
      include_vars:
        dir: vars/{{ env }}
      tags: [pre-ami, post-ami]

    - name: Apply base Cloudwatch Agent Role
      import_role:
        name: cloudwatch-agent-instrumented
      tags:
        - pre-ami

    - name: Apply latest host security patches
      import_role:
        name: base_patch
      tags:
        - pre-ami

    - name: Apply server-load Role
      import_role:
        name: bfd-server-load
      vars:
        server_load_dir: "{{ bfd_migrator_dir }}"
        server_load_tmp_dir: "{{ bfd_migrator_dir }}/tmp"
      tags:
        - pre-ami

    - name: Add SSH users
      import_role:
        name: ssh_users
      tags:
        - pre-ami
