---
##
# Configures the BFD DB Migrator Service for CCS env
##
- name: Configure server-load Controller
  hosts: all
  become: true
  remote_user: ec2-user
  gather_facts: no
  vars:
    server_load_dir: /opt/server-load
    # TODO: Remove this when CloudWatch Agent role is properly removed from build tasks
    env: "test"
    # TODO: Resolve this as feasible
    python3_version: '3.9.16'

  tasks:
    - name: Download BFD Repository
      git:
        repo: https://github.com/CMSgov/beneficiary-fhir-data.git
        dest: /beneficiary-fhir-data
        # use hash from `git_commit` when on stable master branch, otherwise use git_branch name
        version: "{{ git_commit if git_branch == 'master' else git_branch }}"
      tags: [pre-ami, post-ami]

    # TODO: This role is _probably_ unused in favor of the CW Agent that is installed during launch -- remove it
    - name: Apply base Cloudwatch Agent Role
      import_role:
        name: cloudwatch-agent-instrumented
      when: env is defined

    - name: Apply latest host security patches
      import_role:
        name: base_patch

    # TODO: Resolve this as feasible
    - name: Create symbolic links
      file:
        src: "{{ item.src }}"
        path: "{{ item.path }}"
        state: link
        force: true
      loop:
        - src: /usr/local/bin/python3.{{ python3_version.split('.')[1] }}
          path: /usr/bin/python3
        - src: /usr/local/bin/pip3.{{ python3_version.split('.')[1] }}
          path: /usr/bin/pip3
      tags:
        - pre-ami

    - name: Apply server-load Role
      import_role:
        name: bfd-server-load
