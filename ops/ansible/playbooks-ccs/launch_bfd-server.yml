---
##
# Configures the FHIR Server and data-server app for CCS env
##
- name: Launch BFD Data Server
  hosts: localhost

  tasks:
    - name: Add SSH users for current environment
      import_role:
        name: ssh_users
      tags:
        - post-ami

    - name: Apply BFD Server Role
      import_role:
        name: bfd-server

    - name: Build CloudWatch unified agent configuration
      template:
        src: cwagent-data-server.json.j2
        dest: '/tmp/cwagent-data-server.json'
        owner: root
        group: root
        mode: u=rw,g=r,o=r
      become: true
      tags:
        - post-ami

    - name: Reconfigure and relaunch CloudWatch unified agent
      shell: "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -c file:/tmp/cwagent-data-server.json -s"
      become: true
      tags:
        - post-ami
