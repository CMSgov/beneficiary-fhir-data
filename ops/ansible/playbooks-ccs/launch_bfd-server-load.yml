- name: Configure server-load Controller
  hosts: localhost
  # TODO: Resolve this as feasible
  vars:
    ansible_ssh_pipelining: false
    python3_version: '3.9.16'

  tasks:
    - name: Add SSH users for current environment
      import_role:
        name: ssh_users
      tags:
        - post-ami

    # TODO: Resolve this as feasible
    - name: Create symbolic links
      file:
        src: "{{ item.src }}"
        path: "{{ item.path }}"
        state: link
        force: true
      loop:
        - src: /usr/local/bin/python3.{{ python3_version.split('.')[1] }}
          path: /usr/bin/python3
        - src: /usr/local/bin/pip3.{{ python3_version.split('.')[1] }}
          path: /usr/bin/pip3
      tags:
        - post-ami

    - name: Apply server-load Role
      import_role:
        name: bfd-server-load
      # Variables for this task are retrieved from user-data.sh inside the server-load terraform
      # module

    - name: Build CloudWatch unified agent configuration
      template:
        src: cwagent-server-load.json.j2
        dest: "/tmp/cwagent-server-load.json"
        owner: root
        group: root
        mode: u=rw,g=r,o=r
      become: true
      tags:
        - post-ami

    - name: Reconfigure and relaunch CloudWatch unified agent
      shell: "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -c file:/tmp/cwagent-server-load.json -s"
      become: true
      tags:
        - post-ami
