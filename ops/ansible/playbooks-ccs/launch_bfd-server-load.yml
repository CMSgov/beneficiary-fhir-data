- name: Configure server-load Controller
  hosts: localhost

  tasks:
    - name: Apply server-load Role
      import_role:
        name: bfd-server-load
      tags:
        - post-ami
      vars:
        # Variables listed are applied from user-data.sh inside the server-load terraform module
        #server_load_sqs_queue_name:
        #server_load_node_lambda_name:
        #server_load_asg_name:
        #server_load_test_host:
        #server_load_aws_current_region:
        #server_load_initial_worker_nodes:
        #server_load_node_spawn_time:
        #server_load_max_spawned_nodes:
        #server_load_max_spawned_users:
        #server_load_user_spawn_rate:
        #server_load_test_runtime_limit:
        #server_load_coasting_time:
        #server_load_warm_instance_target:
        #server_load_stop_on_scaling:
        #server_load_stop_on_node_limit:

    # TODO: Consider moving the CloudWatch agent configuration elsewhere, potentially in the application role or a cloudwatch-specific role. This is a little awkward.
    - name: Build CloudWatch unified agent configuration
      template:
        src: cwagent-server-load.json.j2
        dest: "/tmp/cwagent-server-load.json"
        owner: root
        group: root
        mode: u=rw,g=r,o=r
      become: true
      tags:
        - post-ami

    - name: Reconfigure and relaunch CloudWatch unified agent
      shell: "/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a append-config -m ec2 -c file:/tmp/cwagent-server-load.json -s"
      become: true
      tags:
        - post-ami
