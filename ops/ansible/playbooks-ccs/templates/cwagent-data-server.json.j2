{
  "metrics": {
    "namespace": "bfd-{{ env }}/bfd-server/CWAgent",
    "metrics_collected": {
      "collectd": {},
      "cpu": {
        "resources": [
          "*"
        ],
        "measurement": [{
            "name": "cpu_usage_idle",
            "rename": "CPU_USAGE_IDLE",
            "unit": "Percent"
          },
          {
            "name": "cpu_usage_nice",
            "unit": "Percent"
          },
          "cpu_usage_guest"
        ],
        "totalcpu": false,
        "metrics_collection_interval": 10,
        "append_dimensions": {
          "test": "test1",
          "date": "2017-10-01"
        }
      },
      "netstat": {
        "measurement": [
          "tcp_established",
          "tcp_syn_sent",
          "tcp_close"
        ],
        "metrics_collection_interval": 60
      },
      "disk": {
        "measurement": [
          "used_percent"
        ],
        "resources": [
          "*"
        ],
        "drop_device": true
      },
      "processes": {
        "measurement": [
          "running",
          "sleeping",
          "dead"
        ]
      }
    },
    "append_dimensions": {
      "ImageId": "${aws:ImageId}",
      "InstanceId": "${aws:InstanceId}",
      "InstanceType": "${aws:InstanceType}",
      "AutoScalingGroupName": "${aws:AutoScalingGroupName}"
    },
    "aggregation_dimensions": [
      ["AutoScalingGroupName"],
      ["InstanceId", "InstanceType"],
      []
    ]
  },
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [{
            "file_path": "/var/log/messages",
            "log_group_name": "/bfd/{{ env }}/var/log/messages",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%b %d %H:%M:%S"
          },
          {
            "file_path": "/var/log/secure",
            "log_group_name": "/bfd/{{ env }}/var/log/secure",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%b %d %H:%M:%S"
          },
          {
            "file_path": "{{ bfd_server_dir }}/access.json",
            "log_group_name": "/bfd/{{ env }}/bfd-server/access.json",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%Y-%m-%dT%H:%M:%S%z"
          },
          {
            "file_path": "{{ bfd_server_dir }}/access.log",
            "log_group_name": "/bfd/{{ env }}/bfd-server/access.txt",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%d/%b/%Y:%H:%M:%S %z"
          },
          {
            "file_path": "{{ bfd_server_dir }}/bluebutton-server-app-log.json",
            "log_group_name": "/bfd/{{ env }}/bfd-server/messages.json",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%Y-%m-%dT%H:%M:%S%z"
          },
          {
            "file_path": "{{ bfd_server_dir }}/gc.log",
            "log_group_name": "/bfd/{{ env }}/bfd-server/gc.log",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%Y-%m-%dT%H:%M:%S%z",
            "multi_line_start_pattern": "^[\\d\\d\\d\\d-\\d\\d-\\d\\d ]"
          },
          {
            "file_path": "{{ bfd_server_dir }}/newrelic_agent.log",
            "log_group_name": "/bfd/{{ env }}/bfd-server/newrelic_agent.log",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%b %d, %Y %H:%M:%S %z"
          },
          {
            "file_path": "{{ bfd_server_dir }}/bfd-server-startup.log",
            "log_group_name": "/bfd/{{ env }}/bfd-server/bfd-server-startup.log",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%Y-%m-%d %H:%M:%S"
          },
          {
            "file_path": "{{ bfd_server_dir }}/loadedFilterManagerLog.json",
            "log_group_name": "/bfd/{{ env }}/bfd-server/loadedFilterManagerLog.log",
            "log_stream_name": "{instance_id}",
            "timestamp_format": "%Y-%m-%d %H:%M:%S"
          }
        ]
      }
    },
    "metrics_collected": {
      "prometheus": {
        "cluster_name": "bfd/{{ env }}/bfd-server",
        "log_group_name": "bfd/{{ env }}/bfd-server/prometheus",
        "prometheus_config_path": "/tmp/cwagent-prometheus.yaml",
        "emf_processor": {
          "metric_declaration_dedup": true,
          "metric_namespace": "bfd-{{ env }}/bfd-server/prometheus",
          "metric_unit": {
            "jvm_threads_current": "Count",
            "jvm_gc_collection_seconds_sum": "Second",
            "jvm_memory_bytes_used": "Bytes"
          },
          "metric_declaration": [{
            "source_labels": [
              "job"
            ],
            "label_matcher": "^jmx$",
            "dimensions": [
              [
                "InstanceId",
                "ComponentName",
                "ImageId",
                "InstanceType",
                "AutoScalingGroupName"
              ],
              [
                "ComponentName"
              ]
            ],
            "metric_selectors": [
              "^java_lang_memory_heapmemoryusage_used$",
              "^java_lang_memory_heapmemoryusage_committed$",
              "^java_lang_operatingsystem_openfiledescriptorcount$",
              "^java_lang_operatingsystem_maxfiledescriptorcount$",
              "^java_lang_operatingsystem_freephysicalmemorysize$",
              "^java_lang_operatingsystem_freeswapspacesize$",
              "^java_lang_threading_threadcount$",
              "^java_lang_threading_daemonthreadcount$",
              "^java_lang_classloading_loadedclasscount$",
              "^java_lang_garbagecollector_collectiontime_copy$",
              "^java_lang_garbagecollector_collectiontime_ps_scavenge$",
              "^java_lang_garbagecollector_collectiontime_parnew$",
              "^java_lang_garbagecollector_collectiontime_marksweepcompact$",
              "^java_lang_garbagecollector_collectiontime_ps_marksweep$",
              "^java_lang_garbagecollector_collectiontime_concurrentmarksweep$",
              "^java_lang_garbagecollector_collectiontime_g1_young_generation$",
              "^java_lang_garbagecollector_collectiontime_g1_old_generation$",
              "^java_lang_garbagecollector_collectiontime_g1_mixed_generation$",
              "^java_lang_operatingsystem_committedvirtualmemorysize$"
            ]
          }]
        }
      }
    }
  }
}