---
##
# Configures the ETL Server and data-pipeline app for CCS env
##
- name: Configure ETL Server
  hosts: all
  become: true
  remote_user: ec2-user
  gather_facts: no
  vars:
    ansible_ssh_pipelining: no
    env: "test"

  tasks:
    
    - name: Include env specific variables
      include_vars:
        dir: environments/{{ env }}
      
    - name: Apply Blue Button Data Pipeline Role
      import_role:
        name: bfd-pipeline
      vars:
        data_pipeline_dir: '/bluebutton-data-pipeline'
        data_pipeline_appjar_name: "bfd-pipeline-app-{{ data_pipeline_version }}-capsule-fat.jar"
        # Will need to update to:
        # data_pipeline_appjar_localpath: "~/.m2/repository/gov/cms/bfd/bfd-pipeline-app/{{ data_pipeline_version }}"
        # Once CCS Jenkins is building artifacts. 
        data_pipeline_appjar_s3_bucket: "{{ s3_bucket_deployment }}"
        data_pipeline_s3_bucket: "{{ s3_bucket_etl_staging }}"
        data_pipeline_jvm_args: "-Xmx{{ ((data_pipeline_ec2_instance_type_mem_mib | int) * 0.80) | int }}m -XX:+PreserveFramePointer"
        data_pipeline_tmp_dir: "{{ data_pipeline_dir }}/tmp"
        data_pipeline_loader_threads: "{{ data_pipeline_ec2_instance_type_vcpu * 25 }}"
        data_pipeline_hicn_hash_iterations: "{{ vault_data_pipeline_hicn_hash_iterations }}"
        data_pipeline_hicn_hash_pepper: "{{ vault_data_pipeline_hicn_hash_pepper }}"
        # Primary (i.e. write) DB defined in `environments/<env>/group_vars/all/vault.yml`:
        data_pipeline_db_url: "{{ vault_data_db_primary_url }}"
        data_pipeline_db_username: "{{ vault_data_pipeline_db_username }}"
        data_pipeline_db_password: "{{ vault_data_pipeline_db_username }}"
        #data_pipeline_loader_threads: (see group_vars/all/main.yml 
        
    - name: Configure CloudWatch Logs Agent
      template:
        src: awslogs.conf.data-pipeline.j2
        dest: '/var/awslogs/etc/awslogs.conf'
        owner: root
        group: root
        mode: u=rw,g=,o=
      become: true
      notify:
        - Restart awslogs Service
        
  handlers:
    - import_tasks: handlers/main.yml
