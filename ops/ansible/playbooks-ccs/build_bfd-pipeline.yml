---
##
# Configures the ETL Server and data-pipeline app for CCS env
##
- name: Configure ETL Server
  hosts: all
  become: true
  remote_user: ec2-user
  gather_facts: yes
  vars:
    ansible_ssh_pipelining: no
    bfd_pipeline_dir: '/bluebutton-data-pipeline'
    env: "test"

  tasks:
    # TODO: Remove include_vars when SSH/sudoer users have been resolved in SSM BFD-2068
    - name: Include env specific variables
      include_vars:
        dir: vars/{{ env }}
      tags: [pre-ami, post-ami]

    - name: Apply base Cloudwatch Agent Role
      import_role:
        name: cloudwatch-agent-instrumented
    
    - name: Apply latest host security patches
      import_role:
        name: base_patch

    - name: Apply Blue Button Data Pipeline Role
      import_role:
        name: bfd-pipeline
      vars:
        data_pipeline_dir: "{{ bfd_pipeline_dir }}"
        data_pipeline_tmp_dir: "{{ bfd_pipeline_dir }}/tmp"
        # Note: The `data_pipeline_zip` variable should have been provided by `--extra-vars` on the command line.

    - name: Add SSH users
      import_role:
        name: ssh_users
      tags:
        - pre-ami

  # TODO: Consider removing this task all together... it doesn't seem to be firing, but the solution continues to work
  handlers:
    - import_tasks: handlers/main.yml
