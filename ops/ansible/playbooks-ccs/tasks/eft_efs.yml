---

## Create posix users and groups
#
# When our partners mount an assigned EFS file system hosted by BFD, 
# they are rooted to a dedicated dropbox folder and assigned a POSIX
# user/group id. All file operations will be performed with these id's
# so we are creating matching users and groups here so we can track
# who owns what files and ensure these user and groups are locked
# down.

- name: Ensure partner EFT EFS groups are present
  become: true
  group:
    name: "{{ item.name }}_eft"
    gid: "{{ item.posix_gid }}"
    system: yes
    state: present
  with_items: "{{ eft_efs_mounts }}"
  tags:
    - pre-ami

- name: Ensure partner EFT EFS users are present
  become: true
  user:
    name: "{{ item.name }}_eft"
    uid: "{{ item.posix_uid }}"
    group: "{{ item.name }}_eft" # takes a group name, not gid
    groups: '' # empty ensures they will only be assigned to the primary group
    append: yes
    comment: "User to identify {{ item.name }} EFT EFS files."
    create_home: no
    expires: -1 # never expire
    shell: /bin/false
    system: yes
    state: present
  with_items: "{{ eft_efs_mounts }}"
  tags:
    - pre-ami

# Create the base EFT EFS mount directory (ex. /mnt/efs)
- name: Ensure base EFT mount directory exists
  become: true
  file:
    path: "{{ eft_efs_base_dir }}"
    state: directory
    owner: 'root'
    group: 'root'
    mode: '0750'
  tags:
    - pre-ami

# Create partner EFT EFS mount directories (ex. /mnt/efs/bcda)
- name: Ensure partner EFT EFS mount directories exists
  become: true
  file:
    path: "{{ eft_efs_base_dir }}/{{ item.name }}"
    state: directory
    mode: '0640'
    owner: "{{ item.name }}_eft"
    group: "{{ item.name }}_eft"
  with_items: "{{ eft_efs_mounts }}"
  tags:
    - pre-ami

# Add the mount helper script to the ETL server. It will be available in /usr/local/sbin/.
- name: Add EFS mount helper scripts
  become: true
  template:
    src: mount-eft-efs-file-systems.sh.j2
    dest: "/usr/local/sbin/mount-{{ item.name }}-eft-efs-file-systems.sh"
    owner: "root"
    group: "root"
    mode: '0755'
  with_items: "{{ eft_efs_mounts }}"
  tags: 
    - pre-ami
