- name: Copy the ds agent upgrade hotfix script
  copy:
    src: "{{ playbook_dir }}/roles/{{ role_name }}/files/{{ item }}"
    dest: "/usr/local/bin/{{ item }}"
    mode: 0755
  with_items:
    - "tm-ds-agent-upgrade.sh"

- name: Run the ds agent hotfix upgrade
  ansible.builtin.shell:
    cmd: "timeout 300 /usr/local/bin/tm-ds-agent-upgrade.sh"
  register: ds_agent_upgrade_result

- name: Fail if ds agent upgrade was unsuccessful
  ansible.builtin.fail:
    msg: "Failed to upgrade DS Agent using hotfix script"
  when: ds_agent_upgrade_result.rc != 0
